const Mr="modulepreload",br=function(o,e){return new URL(o,e).href},os={},mi=function(e,t,r){if(!t||t.length===0)return e();const s=document.getElementsByTagName("link");return Promise.all(t.map(n=>{if(n=br(n,r),n in os)return;os[n]=!0;const i=n.endsWith(".css"),a=i?'[rel="stylesheet"]':"";if(!!r)for(let p=s.length-1;p>=0;p--){const T=s[p];if(T.href===n&&(!i||T.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${n}"]${a}`))return;const g=document.createElement("link");if(g.rel=i?"stylesheet":Mr,i||(g.as="script",g.crossOrigin=""),g.href=n,document.head.appendChild(g),i)return new Promise((p,T)=>{g.addEventListener("load",p),g.addEventListener("error",()=>T(new Error(`Unable to preload CSS for ${n}`)))})})).then(()=>e()).catch(n=>{const i=new Event("vite:preloadError",{cancelable:!0});if(i.payload=n,window.dispatchEvent(i),!i.defaultPrevented)throw n})};class Vt{constructor(){this._listeners={}}addEventListener(e,t){const r=this._listeners;return r[e]===void 0&&(r[e]=[]),r[e].indexOf(t)===-1&&r[e].push(t),this}removeEventListener(e,t){if(this._listeners===void 0)return this;const s=this._listeners[e];if(s!==void 0){const n=s.indexOf(t);n!==-1&&s.splice(n,1)}return this}dispatchEvent(e){if(this._listeners===void 0)return this;const r=this._listeners[e.type];if(r!==void 0){const s=r.slice(0);for(let n=0,i=s.length;n<i;n++)s[n].call(this,e)}return this}dispose(){for(const e in this._listeners)delete this._listeners[e]}}class Be extends Vt{constructor(e,t,r,s={}){if(super(),this._name=void 0,this._parent=void 0,this._child=void 0,this._attributes=void 0,this._disposed=!1,this._name=e,this._parent=t,this._child=r,this._attributes=s,!t.isOnGraph(r))throw new Error("Cannot connect disconnected graphs.")}getName(){return this._name}getParent(){return this._parent}getChild(){return this._child}setChild(e){return this._child=e,this}getAttributes(){return this._attributes}dispose(){this._disposed||(this._disposed=!0,this.dispatchEvent({type:"dispose",target:this}),super.dispose())}isDisposed(){return this._disposed}}class wr extends Vt{constructor(...e){super(...e),this._emptySet=new Set,this._edges=new Set,this._parentEdges=new Map,this._childEdges=new Map}listEdges(){return Array.from(this._edges)}listParentEdges(e){return Array.from(this._childEdges.get(e)||this._emptySet)}listParents(e){return this.listParentEdges(e).map(t=>t.getParent())}listChildEdges(e){return Array.from(this._parentEdges.get(e)||this._emptySet)}listChildren(e){return this.listChildEdges(e).map(t=>t.getChild())}disconnectParents(e,t){let r=this.listParentEdges(e);return t&&(r=r.filter(s=>t(s.getParent()))),r.forEach(s=>s.dispose()),this}createEdge(e,t,r,s){return this._registerEdge(new Be(e,t,r,s))}_registerEdge(e){this._edges.add(e);const t=e.getParent();this._parentEdges.has(t)||this._parentEdges.set(t,new Set),this._parentEdges.get(t).add(e);const r=e.getChild();return this._childEdges.has(r)||this._childEdges.set(r,new Set),this._childEdges.get(r).add(e),e.addEventListener("dispose",()=>this._removeEdge(e)),e}_removeEdge(e){return this._edges.delete(e),this._parentEdges.get(e.getParent()).delete(e),this._childEdges.get(e.getChild()).delete(e),this}}function Ke(){return Ke=Object.assign||function(o){for(var e=1;e<arguments.length;e++){var t=arguments[e];for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(o[r]=t[r])}return o},Ke.apply(this,arguments)}function Ot(o){return o instanceof Be}function $e(o){return Array.isArray(o)&&o[0]instanceof Be}function ze(o){return!!(Or(o)&&Cr(o)instanceof Be)}function Cr(o){for(const e in o)return o[e]}function Or(o){return!!o&&Object.getPrototypeOf(o)===Object.prototype}const F=Symbol("attributes"),Ue=Symbol("immutableKeys");class kt extends Vt{constructor(e){super(),this._disposed=!1,this.graph=void 0,this[F]=void 0,this[Ue]=void 0,this.graph=e,this[Ue]=new Set,this[F]=this._createAttributes()}getDefaults(){return{}}_createAttributes(){const e=this.getDefaults(),t={};for(const r in e){const s=e[r];if(s instanceof kt){const n=this.graph.createEdge(r,this,s);n.addEventListener("dispose",()=>s.dispose()),this[Ue].add(r),t[r]=n}else t[r]=s}return t}isOnGraph(e){return this.graph===e.graph}isDisposed(){return this._disposed}dispose(){this._disposed||(this.graph.listChildEdges(this).forEach(e=>e.dispose()),this.graph.disconnectParents(this),this._disposed=!0,this.dispatchEvent({type:"dispose"}))}detach(){return this.graph.disconnectParents(this),this}swap(e,t){for(const r in this[F]){const s=this[F][r];if(Ot(s)){const n=s;n.getChild()===e&&this.setRef(r,t,n.getAttributes())}else if($e(s)){const i=s.find(a=>a.getChild()===e);if(i){const a=i.getAttributes();this.removeRef(r,e).addRef(r,t,a)}}else if(ze(s)){const n=s;for(const i in n){const a=n[i];a.getChild()===e&&this.setRefMap(r,i,t,a.getAttributes())}}}return this}get(e){return this[F][e]}set(e,t){return this[F][e]=t,this.dispatchEvent({type:"change",attribute:e})}getRef(e){const t=this[F][e];return t?t.getChild():null}setRef(e,t,r){if(this[Ue].has(e))throw new Error(`Cannot overwrite immutable attribute, "${e}".`);const s=this[F][e];if(s&&s.dispose(),!t)return this;const n=this.graph.createEdge(e,this,t,r);return n.addEventListener("dispose",()=>{delete this[F][e],this.dispatchEvent({type:"change",attribute:e})}),this[F][e]=n,this.dispatchEvent({type:"change",attribute:e})}listRefs(e){return this[F][e].map(r=>r.getChild())}addRef(e,t,r){const s=this.graph.createEdge(e,this,t,r),n=this[F][e];return n.push(s),s.addEventListener("dispose",()=>{let i;for(;(i=n.indexOf(s))!==-1;)n.splice(i,1);this.dispatchEvent({type:"change",attribute:e})}),this.dispatchEvent({type:"change",attribute:e})}removeRef(e,t){return this[F][e].filter(n=>n.getChild()===t).forEach(n=>n.dispose()),this}listRefMapKeys(e){return Object.keys(this[F][e])}listRefMapValues(e){return Object.values(this[F][e]).map(t=>t.getChild())}getRefMap(e,t){const r=this[F][e];return r[t]?r[t].getChild():null}setRefMap(e,t,r,s){const n=this[F][e],i=n[t];if(i&&i.dispose(),!r)return this;s=Object.assign(s||{},{key:t});const a=this.graph.createEdge(e,this,r,Ke({},s,{key:t}));return a.addEventListener("dispose",()=>{delete n[t],this.dispatchEvent({type:"change",attribute:e,key:t})}),n[t]=a,this.dispatchEvent({type:"change",attribute:e,key:t})}dispatchEvent(e){return super.dispatchEvent(Ke({},e,{target:this})),this.graph.dispatchEvent(Ke({},e,{target:this,type:`node:${e.type}`})),this}}const Us="v3.5.1",Pe="@glb.bin";var m,mt,re,ae,_e;(function(o){o.ACCESSOR="Accessor",o.ANIMATION="Animation",o.ANIMATION_CHANNEL="AnimationChannel",o.ANIMATION_SAMPLER="AnimationSampler",o.BUFFER="Buffer",o.CAMERA="Camera",o.MATERIAL="Material",o.MESH="Mesh",o.PRIMITIVE="Primitive",o.PRIMITIVE_TARGET="PrimitiveTarget",o.NODE="Node",o.ROOT="Root",o.SCENE="Scene",o.SKIN="Skin",o.TEXTURE="Texture",o.TEXTURE_INFO="TextureInfo"})(m||(m={})),function(o){o.INTERLEAVED="interleaved",o.SEPARATE="separate"}(mt||(mt={})),function(o){o.ARRAY_BUFFER="ARRAY_BUFFER",o.ELEMENT_ARRAY_BUFFER="ELEMENT_ARRAY_BUFFER",o.INVERSE_BIND_MATRICES="INVERSE_BIND_MATRICES",o.OTHER="OTHER",o.SPARSE="SPARSE"}(re||(re={})),function(o){o[o.R=4096]="R",o[o.G=256]="G",o[o.B=16]="B",o[o.A=1]="A"}(ae||(ae={})),function(o){o.GLTF="GLTF",o.GLB="GLB"}(_e||(_e={}));const xt={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array};var at,_t=typeof Float32Array<"u"?Float32Array:Array;function Mt(o){return Math.hypot(o[0],o[1],o[2])}function _r(o,e,t){var r=e[0],s=e[1],n=e[2],i=t[3]*r+t[7]*s+t[11]*n+t[15];return o[0]=(t[0]*r+t[4]*s+t[8]*n+t[12])/(i=i||1),o[1]=(t[1]*r+t[5]*s+t[9]*n+t[13])/i,o[2]=(t[2]*r+t[6]*s+t[10]*n+t[14])/i,o}function vr(o){const e={min:[1/0,1/0,1/0],max:[-1/0,-1/0,-1/0]},t=o.propertyType===m.NODE?[o]:o.listChildren();for(const r of t)r.traverse(s=>{const n=s.getMesh();if(!n)return;const i=Dr(n,s.getWorldMatrix());vt(i.min,e),vt(i.max,e)});return e}Math.hypot||(Math.hypot=function(){for(var o=0,e=arguments.length;e--;)o+=arguments[e]*arguments[e];return Math.sqrt(o)}),at=new _t(3),_t!=Float32Array&&(at[0]=0,at[1]=0,at[2]=0);function Dr(o,e){const t={min:[1/0,1/0,1/0],max:[-1/0,-1/0,-1/0]};for(const r of o.listPrimitives()){const s=r.getAttribute("POSITION");if(!s)continue;let n=[0,0,0],i=[0,0,0];for(let a=0;a<s.getCount();a++)n=s.getElement(a,n),i=_r(i,n,e),vt(i,t)}return t}function vt(o,e){for(let t=0;t<3;t++)e.min[t]=Math.min(o[t],e.min[t]),e.max[t]=Math.max(o[t],e.max[t])}class O{static createBufferFromDataURI(e){if(typeof Buffer>"u"){const t=atob(e.split(",")[1]),r=new Uint8Array(t.length);for(let s=0;s<t.length;s++)r[s]=t.charCodeAt(s);return r}{const t=e.split(",")[1],r=e.indexOf("base64")>=0;return Buffer.from(t,r?"base64":"utf8")}}static encodeText(e){return typeof TextEncoder<"u"?new TextEncoder().encode(e):Buffer.from(e)}static decodeText(e){return typeof TextDecoder<"u"?new TextDecoder().decode(e):Buffer.from(e).toString("utf8")}static concat(e){let t=0;for(const n of e)t+=n.byteLength;const r=new Uint8Array(t);let s=0;for(const n of e)r.set(n,s),s+=n.byteLength;return r}static pad(e,t=0){const r=this.padNumber(e.byteLength);if(r===e.byteLength)return e;const s=new Uint8Array(r);if(s.set(e),t!==0)for(let n=e.byteLength;n<r;n++)s[n]=t;return s}static padNumber(e){return 4*Math.ceil(e/4)}static equals(e,t){if(e===t)return!0;if(e.byteLength!==t.byteLength)return!1;let r=e.byteLength;for(;r--;)if(e[r]!==t[r])return!1;return!0}static toView(e,t=0,r=1/0){return new Uint8Array(e.buffer,e.byteOffset+t,Math.min(e.byteLength,r))}static assertView(e){if(e&&!ArrayBuffer.isView(e))throw new Error(`Method requires Uint8Array parameter; received "${typeof e}".`);return e}}let se=class{static hexToFactor(e,t){e=Math.floor(e);const r=t;return r[0]=(e>>16&255)/255,r[1]=(e>>8&255)/255,r[2]=(255&e)/255,this.convertSRGBToLinear(t,t)}static factorToHex(e){const t=[...e],[r,s,n]=this.convertLinearToSRGB(e,t);return 255*r<<16^255*s<<8^255*n<<0}static convertSRGBToLinear(e,t){const r=e,s=t;for(let n=0;n<3;n++)s[n]=r[n]<.04045?.0773993808*r[n]:Math.pow(.9478672986*r[n]+.0521327014,2.4);return t}static convertLinearToSRGB(e,t){const r=e,s=t;for(let n=0;n<3;n++)s[n]=r[n]<.0031308?12.92*r[n]:1.055*Math.pow(r[n],.41666)-.055;return t}},Ls=class Bs{match(e){return e.length>=8&&e[0]===137&&e[1]===80&&e[2]===78&&e[3]===71&&e[4]===13&&e[5]===10&&e[6]===26&&e[7]===10}getSize(e){const t=new DataView(e.buffer,e.byteOffset);return O.decodeText(e.slice(12,16))===Bs.PNG_FRIED_CHUNK_NAME?[t.getUint32(32,!1),t.getUint32(36,!1)]:[t.getUint32(16,!1),t.getUint32(20,!1)]}getChannels(e){return 4}};Ls.PNG_FRIED_CHUNK_NAME="CgBI";let he=class{static registerFormat(e,t){this.impls[e]=t}static getMimeType(e){for(const t in this.impls)if(this.impls[t].match(e))return t;return null}static getSize(e,t){return this.impls[t]?this.impls[t].getSize(e):null}static getChannels(e,t){return this.impls[t]?this.impls[t].getChannels(e):null}static getVRAMByteLength(e,t){if(!this.impls[t])return null;if(this.impls[t].getVRAMByteLength)return this.impls[t].getVRAMByteLength(e);let r=0;const s=this.getSize(e,t);if(!s)return null;for(;s[0]>1||s[1]>1;)r+=s[0]*s[1]*4,s[0]=Math.max(Math.floor(s[0]/2),1),s[1]=Math.max(Math.floor(s[1]/2),1);return r+=4,r}static mimeTypeToExtension(e){return e==="image/jpeg"?"jpg":e.split("/").pop()}static extensionToMimeType(e){return e==="jpg"?"image/jpeg":e?`image/${e}`:""}};function Fr(o,e){if(e>o.byteLength)throw new TypeError("Corrupt JPG, exceeded buffer limits");if(o.getUint8(e)!==255)throw new TypeError("Invalid JPG, marker table corrupted");return o}he.impls={"image/jpeg":new class{match(o){return o.length>=3&&o[0]===255&&o[1]===216&&o[2]===255}getSize(o){let e,t,r=new DataView(o.buffer,o.byteOffset+4);for(;r.byteLength;){if(e=r.getUint16(0,!1),Fr(r,e),t=r.getUint8(e+1),t===192||t===193||t===194)return[r.getUint16(e+7,!1),r.getUint16(e+5,!1)];r=new DataView(o.buffer,r.byteOffset+e+2)}throw new TypeError("Invalid JPG, no size found")}getChannels(o){return 3}},"image/png":new Ls};let je=class{static basename(e){const t=e.split(/[\\/]/).pop();return t.substring(0,t.lastIndexOf("."))}static extension(e){if(e.startsWith("data:image/")){const t=e.match(/data:(image\/\w+)/)[1];return he.mimeTypeToExtension(t)}return e.startsWith("data:model/gltf+json")?"gltf":e.startsWith("data:model/gltf-binary")?"glb":e.startsWith("data:application/")?"bin":e.split(/[\\/]/).pop().split(/[.]/).pop()}};function as(o){return Object.prototype.toString.call(o)==="[object Object]"}function Oe(o){if(as(o)===!1)return!1;const e=o.constructor;if(e===void 0)return!0;const t=e.prototype;return as(t)!==!1&&Object.prototype.hasOwnProperty.call(t,"isPrototypeOf")!==!1}var Dt;(function(o){o[o.SILENT=4]="SILENT",o[o.ERROR=3]="ERROR",o[o.WARN=2]="WARN",o[o.INFO=1]="INFO",o[o.DEBUG=0]="DEBUG"})(Dt||(Dt={}));let xe=class He{constructor(e){this.verbosity=void 0,this.verbosity=e}debug(e){this.verbosity<=He.Verbosity.DEBUG&&console.debug(e)}info(e){this.verbosity<=He.Verbosity.INFO&&console.info(e)}warn(e){this.verbosity<=He.Verbosity.WARN&&console.warn(e)}error(e){this.verbosity<=He.Verbosity.ERROR&&console.error(e)}};function Ur(o,e,t){var r=e[0],s=e[1],n=e[2],i=e[3],a=e[4],u=e[5],g=e[6],p=e[7],T=e[8],x=e[9],R=e[10],E=e[11],A=e[12],l=e[13],y=e[14],c=e[15],h=t[0],f=t[1],d=t[2],I=t[3];return o[0]=h*r+f*a+d*T+I*A,o[1]=h*s+f*u+d*x+I*l,o[2]=h*n+f*g+d*R+I*y,o[3]=h*i+f*p+d*E+I*c,o[4]=(h=t[4])*r+(f=t[5])*a+(d=t[6])*T+(I=t[7])*A,o[5]=h*s+f*u+d*x+I*l,o[6]=h*n+f*g+d*R+I*y,o[7]=h*i+f*p+d*E+I*c,o[8]=(h=t[8])*r+(f=t[9])*a+(d=t[10])*T+(I=t[11])*A,o[9]=h*s+f*u+d*x+I*l,o[10]=h*n+f*g+d*R+I*y,o[11]=h*i+f*p+d*E+I*c,o[12]=(h=t[12])*r+(f=t[13])*a+(d=t[14])*T+(I=t[15])*A,o[13]=h*s+f*u+d*x+I*l,o[14]=h*n+f*g+d*R+I*y,o[15]=h*i+f*p+d*E+I*c,o}xe.Verbosity=Dt,xe.DEFAULT_INSTANCE=new xe(xe.Verbosity.INFO);let j=class Ft{static identity(e){return e}static eq(e,t,r=1e-5){if(e.length!==t.length)return!1;for(let s=0;s<e.length;s++)if(Math.abs(e[s]-t[s])>r)return!1;return!0}static decodeNormalizedInt(e,t){switch(t){case 5126:return e;case 5123:return e/65535;case 5121:return e/255;case 5122:return Math.max(e/32767,-1);case 5120:return Math.max(e/127,-1);default:throw new Error("Invalid component type.")}}static denormalize(e,t){return Ft.decodeNormalizedInt(e,t)}static encodeNormalizedInt(e,t){switch(t){case 5126:return e;case 5123:return Math.round(65535*e);case 5121:return Math.round(255*e);case 5122:return Math.round(32767*e);case 5120:return Math.round(127*e);default:throw new Error("Invalid component type.")}}static normalize(e,t){return Ft.encodeNormalizedInt(e,t)}static decompose(e,t,r,s){let n=Mt([e[0],e[1],e[2]]);const i=Mt([e[4],e[5],e[6]]),a=Mt([e[8],e[9],e[10]]);var u,g,p,T,x,R,E,A,l,y,c,h,f,d,I,M,S;((g=(u=e)[0])*(E=u[5])-(p=u[1])*(R=u[4]))*((h=u[10])*(S=u[15])-(f=u[11])*(M=u[14]))-(g*(A=u[6])-(T=u[2])*R)*((c=u[9])*S-f*(I=u[13]))+(g*(l=u[7])-(x=u[3])*R)*(c*M-h*I)+(p*A-T*E)*((y=u[8])*S-f*(d=u[12]))-(p*l-x*E)*(y*M-h*d)+(T*l-x*A)*(y*I-c*d)<0&&(n=-n),t[0]=e[12],t[1]=e[13],t[2]=e[14];const N=e.slice(),v=1/n,b=1/i,U=1/a;N[0]*=v,N[1]*=v,N[2]*=v,N[4]*=b,N[5]*=b,N[6]*=b,N[8]*=U,N[9]*=U,N[10]*=U,function(w,C){var D=new _t(3);(function(St,ge){var yr=ge[4],Rr=ge[5],Ir=ge[6],Ar=ge[8],Nr=ge[9],Sr=ge[10];St[0]=Math.hypot(ge[0],ge[1],ge[2]),St[1]=Math.hypot(yr,Rr,Ir),St[2]=Math.hypot(Ar,Nr,Sr)})(D,C);var q=1/D[0],H=1/D[1],ne=1/D[2],Y=C[0]*q,P=C[1]*H,W=C[2]*ne,K=C[4]*q,ce=C[5]*H,oe=C[6]*ne,it=C[8]*q,ot=C[9]*H,De=C[10]*ne,is=Y+ce+De,z=0;is>0?(z=2*Math.sqrt(is+1),w[3]=.25*z,w[0]=(oe-ot)/z,w[1]=(it-W)/z,w[2]=(P-K)/z):Y>ce&&Y>De?(z=2*Math.sqrt(1+Y-ce-De),w[3]=(oe-ot)/z,w[0]=.25*z,w[1]=(P+K)/z,w[2]=(it+W)/z):ce>De?(z=2*Math.sqrt(1+ce-Y-De),w[3]=(it-W)/z,w[0]=(P+K)/z,w[1]=.25*z,w[2]=(oe+ot)/z):(z=2*Math.sqrt(1+De-Y-ce),w[3]=(P-K)/z,w[0]=(it+W)/z,w[1]=(oe+ot)/z,w[2]=.25*z)}(r,N),s[0]=n,s[1]=i,s[2]=a}static compose(e,t,r,s){const n=s,i=t[0],a=t[1],u=t[2],g=t[3],p=i+i,T=a+a,x=u+u,R=i*p,E=i*T,A=i*x,l=a*T,y=a*x,c=u*x,h=g*p,f=g*T,d=g*x,I=r[0],M=r[1],S=r[2];return n[0]=(1-(l+c))*I,n[1]=(E+d)*I,n[2]=(A-f)*I,n[3]=0,n[4]=(E-d)*M,n[5]=(1-(R+c))*M,n[6]=(y+h)*M,n[7]=0,n[8]=(A+f)*S,n[9]=(y-h)*S,n[10]=(1-(R+l))*S,n[11]=0,n[12]=e[0],n[13]=e[1],n[14]=e[2],n[15]=1,n}};function Lr(o,e){if(!!o!=!!e)return!1;const t=o.getChild(),r=e.getChild();return t===r||t.equals(r)}function Br(o,e){if(!!o!=!!e||o.length!==e.length)return!1;for(let t=0;t<o.length;t++){const r=o[t],s=e[t];if(r.getChild()!==s.getChild()&&!r.getChild().equals(s.getChild()))return!1}return!0}function Pr(o,e){if(!!o!=!!e)return!1;const t=Object.keys(o),r=Object.keys(e);if(t.length!==r.length)return!1;for(const s in o){const n=o[s],i=e[s];if(!!n!=!!i)return!1;const a=n.getChild(),u=i.getChild();if(a!==u&&!a.equals(u))return!1}return!0}function Ps(o,e){if(o===e)return!0;if(!!o!=!!e||!o||!e||o.length!==e.length)return!1;for(let t=0;t<o.length;t++)if(o[t]!==e[t])return!1;return!0}function js(o,e){if(o===e)return!0;if(!!o!=!!e)return!1;if(!Oe(o)||!Oe(e))return o===e;const t=o,r=e;let s,n=0,i=0;for(s in t)n++;for(s in r)i++;if(n!==i)return!1;for(s in t){const a=t[s],u=r[s];if(Tt(a)&&Tt(u)){if(!Ps(a,u))return!1}else if(Oe(a)&&Oe(u)){if(!js(a,u))return!1}else if(a!==u)return!1}return!0}function Tt(o){return Array.isArray(o)||ArrayBuffer.isView(o)}const cs=new Set,jr=function(){let o="";for(let e=0;e<6;e++)o+="23456789abdegjkmnpqrvwxyzABDEGJKMNPQRVWXYZ".charAt(Math.floor(42*Math.random()));return o},Vr=function(){for(let o=0;o<999;o++){const e=jr();if(!cs.has(e))return cs.add(e),e}return""},us="https://null.example";let We=class{static dirname(e){const t=e.lastIndexOf("/");return t===-1?"./":e.substring(0,t+1)}static basename(e){return je.basename(new URL(e,us).pathname)}static extension(e){return je.extension(new URL(e,us).pathname)}static resolve(e,t){if(!this.isRelativePath(t))return t;const r=e.split("/"),s=t.split("/");r.pop();for(let n=0;n<s.length;n++)s[n]!=="."&&(s[n]===".."?r.pop():r.push(s[n]));return r.join("/")}static isAbsoluteURL(e){return this.PROTOCOL_REGEXP.test(e)}static isRelativePath(e){return!/^(?:[a-zA-Z]+:)?\//.test(e)}};We.DEFAULT_INIT={},We.PROTOCOL_REGEXP=/^[a-zA-Z]+:\/\//;const me=o=>o,kr=new Set;let Gt=class extends kt{constructor(e,t=""){super(e),this[F].name=t,this.init(),this.dispatchEvent({type:"create"})}getGraph(){return this.graph}getDefaults(){return Object.assign(super.getDefaults(),{name:"",extras:{}})}set(e,t){return Array.isArray(t)&&(t=t.slice()),super.set(e,t)}getName(){return this.get("name")}setName(e){return this.set("name",e)}getExtras(){return this.get("extras")}setExtras(e){return this.set("extras",e)}clone(){return new this.constructor(this.graph).copy(this,me)}copy(e,t=me){for(const r in this[F]){const s=this[F][r];if(s instanceof Be)this[Ue].has(r)||s.dispose();else if($e(s))for(const n of s)n.dispose();else if(ze(s))for(const n in s)s[n].dispose()}for(const r in e[F]){const s=this[F][r],n=e[F][r];if(n instanceof Be)this[Ue].has(r)?s.getChild().copy(t(n.getChild()),t):this.setRef(r,t(n.getChild()),n.getAttributes());else if($e(n))for(const i of n)this.addRef(r,t(i.getChild()),i.getAttributes());else if(ze(n))for(const i in n){const a=n[i];this.setRefMap(r,i,t(a.getChild()),a.getAttributes())}else this[F][r]=Oe(n)?JSON.parse(JSON.stringify(n)):Array.isArray(n)||n instanceof ArrayBuffer||ArrayBuffer.isView(n)?n.slice():n}return this}equals(e,t=kr){if(this===e)return!0;if(this.propertyType!==e.propertyType)return!1;for(const r in this[F]){if(t.has(r))continue;const s=this[F][r],n=e[F][r];if(Ot(s)||Ot(n)){if(!Lr(s,n))return!1}else if($e(s)||$e(n)){if(!Br(s,n))return!1}else if(ze(s)||ze(n)){if(!Pr(s,n))return!1}else if(Oe(s)||Oe(n)){if(!js(s,n))return!1}else if(Tt(s)||Tt(n)){if(!Ps(s,n))return!1}else if(s!==n)return!1}return!0}detach(){return this.graph.disconnectParents(this,e=>e.propertyType!=="Root"),this}listParents(){return this.graph.listParents(this)}},ee=class extends Gt{getDefaults(){return Object.assign(super.getDefaults(),{extensions:{}})}getExtension(e){return this.getRefMap("extensions",e)}setExtension(e,t){return t&&t.t(this),this.setRefMap("extensions",e,t)}listExtensions(){return this.listRefMapValues("extensions")}},_=class L extends ee{constructor(...e){super(...e),this.i=j.identity,this.o=j.identity}init(){this.propertyType=m.ACCESSOR}getDefaults(){return Object.assign(super.getDefaults(),{array:null,type:L.Type.SCALAR,componentType:L.ComponentType.FLOAT,normalized:!1,sparse:!1,buffer:null})}copy(e,t=me){return super.copy(e,t),this.i=e.i,this.o=e.o,this}static getElementSize(e){switch(e){case L.Type.SCALAR:return 1;case L.Type.VEC2:return 2;case L.Type.VEC3:return 3;case L.Type.VEC4:case L.Type.MAT2:return 4;case L.Type.MAT3:return 9;case L.Type.MAT4:return 16;default:throw new Error("Unexpected type: "+e)}}static getComponentSize(e){switch(e){case L.ComponentType.BYTE:case L.ComponentType.UNSIGNED_BYTE:return 1;case L.ComponentType.SHORT:case L.ComponentType.UNSIGNED_SHORT:return 2;case L.ComponentType.UNSIGNED_INT:case L.ComponentType.FLOAT:return 4;default:throw new Error("Unexpected component type: "+e)}}getMinNormalized(e){const t=this.getElementSize();this.getMin(e);for(let r=0;r<t;r++)e[r]=this.o(e[r]);return e}getMin(e){const t=this.get("array"),r=this.getCount(),s=this.getElementSize();for(let n=0;n<s;n++)e[n]=1/0;for(let n=0;n<r*s;n+=s)for(let i=0;i<s;i++){const a=t[n+i];Number.isFinite(a)&&(e[i]=Math.min(e[i],a))}return e}getMaxNormalized(e){const t=this.getElementSize();this.getMax(e);for(let r=0;r<t;r++)e[r]=this.o(e[r]);return e}getMax(e){const t=this.get("array"),r=this.getCount(),s=this.getElementSize();for(let n=0;n<s;n++)e[n]=-1/0;for(let n=0;n<r*s;n+=s)for(let i=0;i<s;i++){const a=t[n+i];Number.isFinite(a)&&(e[i]=Math.max(e[i],a))}return e}getCount(){const e=this.get("array");return e?e.length/this.getElementSize():0}getType(){return this.get("type")}setType(e){return this.set("type",e)}getElementSize(){return L.getElementSize(this.get("type"))}getComponentSize(){return this.get("array").BYTES_PER_ELEMENT}getComponentType(){return this.get("componentType")}getNormalized(){return this.get("normalized")}setNormalized(e){return this.set("normalized",e),e?(this.o=t=>j.decodeNormalizedInt(t,this.get("componentType")),this.i=t=>j.encodeNormalizedInt(t,this.get("componentType"))):(this.o=j.identity,this.i=j.identity),this}getScalar(e){const t=this.getElementSize();return this.o(this.get("array")[e*t])}setScalar(e,t){return this.get("array")[e*this.getElementSize()]=this.i(t),this}getElement(e,t){const r=this.getElementSize(),s=this.get("array");for(let n=0;n<r;n++)t[n]=this.o(s[e*r+n]);return t}setElement(e,t){const r=this.getElementSize(),s=this.get("array");for(let n=0;n<r;n++)s[e*r+n]=this.i(t[n]);return this}getSparse(){return this.get("sparse")}setSparse(e){return this.set("sparse",e)}getBuffer(){return this.getRef("buffer")}setBuffer(e){return this.setRef("buffer",e)}getArray(){return this.get("array")}setArray(e){return this.set("componentType",e?function(t){switch(t.constructor){case Float32Array:return L.ComponentType.FLOAT;case Uint32Array:return L.ComponentType.UNSIGNED_INT;case Uint16Array:return L.ComponentType.UNSIGNED_SHORT;case Uint8Array:return L.ComponentType.UNSIGNED_BYTE;case Int16Array:return L.ComponentType.SHORT;case Int8Array:return L.ComponentType.BYTE;default:throw new Error("Unknown accessor componentType.")}}(e):L.ComponentType.FLOAT),this.set("array",e),this}getByteLength(){const e=this.get("array");return e?e.byteLength:0}};_.Type={SCALAR:"SCALAR",VEC2:"VEC2",VEC3:"VEC3",VEC4:"VEC4",MAT2:"MAT2",MAT3:"MAT3",MAT4:"MAT4"},_.ComponentType={BYTE:5120,UNSIGNED_BYTE:5121,SHORT:5122,UNSIGNED_SHORT:5123,UNSIGNED_INT:5125,FLOAT:5126};let Vs=class extends ee{init(){this.propertyType=m.ANIMATION}getDefaults(){return Object.assign(super.getDefaults(),{channels:[],samplers:[]})}addChannel(e){return this.addRef("channels",e)}removeChannel(e){return this.removeRef("channels",e)}listChannels(){return this.listRefs("channels")}addSampler(e){return this.addRef("samplers",e)}removeSampler(e){return this.removeRef("samplers",e)}listSamplers(){return this.listRefs("samplers")}},rt=class extends ee{init(){this.propertyType=m.ANIMATION_CHANNEL}getDefaults(){return Object.assign(super.getDefaults(),{targetPath:null,targetNode:null,sampler:null})}getTargetPath(){return this.get("targetPath")}setTargetPath(e){return this.set("targetPath",e)}getTargetNode(){return this.getRef("targetNode")}setTargetNode(e){return this.setRef("targetNode",e)}getSampler(){return this.getRef("sampler")}setSampler(e){return this.setRef("sampler",e)}};rt.TargetPath={TRANSLATION:"translation",ROTATION:"rotation",SCALE:"scale",WEIGHTS:"weights"};let Nt=class ks extends ee{init(){this.propertyType=m.ANIMATION_SAMPLER}getDefaultAttributes(){return Object.assign(super.getDefaults(),{interpolation:ks.Interpolation.LINEAR,input:null,output:null})}getInterpolation(){return this.get("interpolation")}setInterpolation(e){return this.set("interpolation",e)}getInput(){return this.getRef("input")}setInput(e){return this.setRef("input",e,{usage:re.OTHER})}getOutput(){return this.getRef("output")}setOutput(e){return this.setRef("output",e,{usage:re.OTHER})}};Nt.Interpolation={LINEAR:"LINEAR",STEP:"STEP",CUBICSPLINE:"CUBICSPLINE"};let Gs=class extends ee{init(){this.propertyType=m.BUFFER}getDefaults(){return Object.assign(super.getDefaults(),{uri:""})}getURI(){return this.get("uri")}setURI(e){return this.set("uri",e)}},nt=class $s extends ee{init(){this.propertyType=m.CAMERA}getDefaults(){return Object.assign(super.getDefaults(),{type:$s.Type.PERSPECTIVE,znear:.1,zfar:100,aspectRatio:null,yfov:2*Math.PI*50/360,xmag:1,ymag:1})}getType(){return this.get("type")}setType(e){return this.set("type",e)}getZNear(){return this.get("znear")}setZNear(e){return this.set("znear",e)}getZFar(){return this.get("zfar")}setZFar(e){return this.set("zfar",e)}getAspectRatio(){return this.get("aspectRatio")}setAspectRatio(e){return this.set("aspectRatio",e)}getYFov(){return this.get("yfov")}setYFov(e){return this.set("yfov",e)}getXMag(){return this.get("xmag")}setXMag(e){return this.set("xmag",e)}getYMag(){return this.get("ymag")}setYMag(e){return this.set("ymag",e)}};nt.Type={PERSPECTIVE:"perspective",ORTHOGRAPHIC:"orthographic"};let k=class extends Gt{t(e){if(!this.parentTypes.includes(e.propertyType))throw new Error(`Parent "${e.propertyType}" invalid for child "${this.propertyType}".`)}};k.EXTENSION_NAME=void 0;let B=class Ut extends ee{init(){this.propertyType=m.TEXTURE_INFO}getDefaults(){return Object.assign(super.getDefaults(),{texCoord:0,magFilter:null,minFilter:null,wrapS:Ut.WrapMode.REPEAT,wrapT:Ut.WrapMode.REPEAT})}getTexCoord(){return this.get("texCoord")}setTexCoord(e){return this.set("texCoord",e)}getMagFilter(){return this.get("magFilter")}setMagFilter(e){return this.set("magFilter",e)}getMinFilter(){return this.get("minFilter")}setMinFilter(e){return this.set("minFilter",e)}getWrapS(){return this.get("wrapS")}setWrapS(e){return this.set("wrapS",e)}getWrapT(){return this.get("wrapT")}setWrapT(e){return this.set("wrapT",e)}};B.WrapMode={CLAMP_TO_EDGE:33071,MIRRORED_REPEAT:33648,REPEAT:10497},B.MagFilter={NEAREST:9728,LINEAR:9729},B.MinFilter={NEAREST:9728,LINEAR:9729,NEAREST_MIPMAP_NEAREST:9984,LINEAR_MIPMAP_NEAREST:9985,NEAREST_MIPMAP_LINEAR:9986,LINEAR_MIPMAP_LINEAR:9987};const{R:ct,G:ut,B:lt,A:Gr}=ae;let Ze=class zs extends ee{init(){this.propertyType=m.MATERIAL}getDefaults(){return Object.assign(super.getDefaults(),{alphaMode:zs.AlphaMode.OPAQUE,alphaCutoff:.5,doubleSided:!1,baseColorFactor:[1,1,1,1],baseColorTexture:null,baseColorTextureInfo:new B(this.graph,"baseColorTextureInfo"),emissiveFactor:[0,0,0],emissiveTexture:null,emissiveTextureInfo:new B(this.graph,"emissiveTextureInfo"),normalScale:1,normalTexture:null,normalTextureInfo:new B(this.graph,"normalTextureInfo"),occlusionStrength:1,occlusionTexture:null,occlusionTextureInfo:new B(this.graph,"occlusionTextureInfo"),roughnessFactor:1,metallicFactor:1,metallicRoughnessTexture:null,metallicRoughnessTextureInfo:new B(this.graph,"metallicRoughnessTextureInfo")})}getDoubleSided(){return this.get("doubleSided")}setDoubleSided(e){return this.set("doubleSided",e)}getAlpha(){return this.get("baseColorFactor")[3]}setAlpha(e){const t=this.get("baseColorFactor").slice();return t[3]=e,this.set("baseColorFactor",t)}getAlphaMode(){return this.get("alphaMode")}setAlphaMode(e){return this.set("alphaMode",e)}getAlphaCutoff(){return this.get("alphaCutoff")}setAlphaCutoff(e){return this.set("alphaCutoff",e)}getBaseColorFactor(){return this.get("baseColorFactor")}setBaseColorFactor(e){return this.set("baseColorFactor",e)}getBaseColorHex(){return se.factorToHex(this.get("baseColorFactor"))}setBaseColorHex(e){const t=this.get("baseColorFactor").slice();return this.set("baseColorFactor",se.hexToFactor(e,t))}getBaseColorTexture(){return this.getRef("baseColorTexture")}getBaseColorTextureInfo(){return this.getRef("baseColorTexture")?this.getRef("baseColorTextureInfo"):null}setBaseColorTexture(e){return this.setRef("baseColorTexture",e,{channels:ct|ut|lt|Gr,isColor:!0})}getEmissiveFactor(){return this.get("emissiveFactor")}setEmissiveFactor(e){return this.set("emissiveFactor",e)}getEmissiveHex(){return se.factorToHex(this.get("emissiveFactor"))}setEmissiveHex(e){const t=this.get("emissiveFactor").slice();return this.set("emissiveFactor",se.hexToFactor(e,t))}getEmissiveTexture(){return this.getRef("emissiveTexture")}getEmissiveTextureInfo(){return this.getRef("emissiveTexture")?this.getRef("emissiveTextureInfo"):null}setEmissiveTexture(e){return this.setRef("emissiveTexture",e,{channels:ct|ut|lt,isColor:!0})}getNormalScale(){return this.get("normalScale")}setNormalScale(e){return this.set("normalScale",e)}getNormalTexture(){return this.getRef("normalTexture")}getNormalTextureInfo(){return this.getRef("normalTexture")?this.getRef("normalTextureInfo"):null}setNormalTexture(e){return this.setRef("normalTexture",e,{channels:ct|ut|lt})}getOcclusionStrength(){return this.get("occlusionStrength")}setOcclusionStrength(e){return this.set("occlusionStrength",e)}getOcclusionTexture(){return this.getRef("occlusionTexture")}getOcclusionTextureInfo(){return this.getRef("occlusionTexture")?this.getRef("occlusionTextureInfo"):null}setOcclusionTexture(e){return this.setRef("occlusionTexture",e,{channels:ct})}getRoughnessFactor(){return this.get("roughnessFactor")}setRoughnessFactor(e){return this.set("roughnessFactor",e)}getMetallicFactor(){return this.get("metallicFactor")}setMetallicFactor(e){return this.set("metallicFactor",e)}getMetallicRoughnessTexture(){return this.getRef("metallicRoughnessTexture")}getMetallicRoughnessTextureInfo(){return this.getRef("metallicRoughnessTexture")?this.getRef("metallicRoughnessTextureInfo"):null}setMetallicRoughnessTexture(e){return this.setRef("metallicRoughnessTexture",e,{channels:ut|lt})}};Ze.AlphaMode={OPAQUE:"OPAQUE",MASK:"MASK",BLEND:"BLEND"};let Hs=class extends ee{init(){this.propertyType=m.MESH}getDefaults(){return Object.assign(super.getDefaults(),{weights:[],primitives:[]})}addPrimitive(e){return this.addRef("primitives",e)}removePrimitive(e){return this.removeRef("primitives",e)}listPrimitives(){return this.listRefs("primitives")}getWeights(){return this.get("weights")}setWeights(e){return this.set("weights",e)}},Xs=class extends ee{constructor(...e){super(...e),this.u=null,this.h=new Set}init(){this.propertyType=m.NODE}getDefaults(){return Object.assign(super.getDefaults(),{translation:[0,0,0],rotation:[0,0,0,1],scale:[1,1,1],weights:[],camera:null,mesh:null,skin:null,children:[]})}copy(e,t=me){if(t===me)throw new Error("Node cannot be copied.");return super.copy(e,t)}getTranslation(){return this.get("translation")}getRotation(){return this.get("rotation")}getScale(){return this.get("scale")}setTranslation(e){return this.set("translation",e)}setRotation(e){return this.set("rotation",e)}setScale(e){return this.set("scale",e)}getMatrix(){return j.compose(this.get("translation"),this.get("rotation"),this.get("scale"),[])}setMatrix(e){const t=this.get("translation").slice(),r=this.get("rotation").slice(),s=this.get("scale").slice();return j.decompose(e,t,r,s),this.set("translation",t).set("rotation",r).set("scale",s)}getWorldTranslation(){const e=[0,0,0];return j.decompose(this.getWorldMatrix(),e,[0,0,0,1],[1,1,1]),e}getWorldRotation(){const e=[0,0,0,1];return j.decompose(this.getWorldMatrix(),[0,0,0],e,[1,1,1]),e}getWorldScale(){const e=[1,1,1];return j.decompose(this.getWorldMatrix(),[0,0,0],[0,0,0,1],e),e}getWorldMatrix(){const e=[];for(let s=this;s!=null;s=s.u)e.push(s);let t;const r=e.pop().getMatrix();for(;t=e.pop();)Ur(r,r,t.getMatrix());return r}addChild(e){if(e.u&&e.u.removeChild(e),e.h.size)for(const r of e.h)r.removeChild(e);this.addRef("children",e),e.u=this;const t=this[F].children;return t[t.length-1].addEventListener("dispose",()=>e.u=null),this}removeChild(e){return this.removeRef("children",e)}listChildren(){return this.listRefs("children")}getParent(){return this.u?this.u:this.listParents().find(e=>e.propertyType===m.SCENE)||null}getParentNode(){return this.u}getMesh(){return this.getRef("mesh")}setMesh(e){return this.setRef("mesh",e)}getCamera(){return this.getRef("camera")}setCamera(e){return this.setRef("camera",e)}getSkin(){return this.getRef("skin")}setSkin(e){return this.setRef("skin",e)}getWeights(){return this.get("weights")}setWeights(e){return this.set("weights",e)}traverse(e){e(this);for(const t of this.listChildren())t.traverse(e);return this}},Qe=class qs extends ee{init(){this.propertyType=m.PRIMITIVE}getDefaults(){return Object.assign(super.getDefaults(),{mode:qs.Mode.TRIANGLES,material:null,indices:null,attributes:{},targets:[]})}getIndices(){return this.getRef("indices")}setIndices(e){return this.setRef("indices",e,{usage:re.ELEMENT_ARRAY_BUFFER})}getAttribute(e){return this.getRefMap("attributes",e)}setAttribute(e,t){return this.setRefMap("attributes",e,t,{usage:re.ARRAY_BUFFER})}listAttributes(){return this.listRefMapValues("attributes")}listSemantics(){return this.listRefMapKeys("attributes")}getMaterial(){return this.getRef("material")}setMaterial(e){return this.setRef("material",e)}getMode(){return this.get("mode")}setMode(e){return this.set("mode",e)}listTargets(){return this.listRefs("targets")}addTarget(e){return this.addRef("targets",e)}removeTarget(e){return this.removeRef("targets",e)}};Qe.Mode={POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6};let $r=class extends Gt{init(){this.propertyType=m.PRIMITIVE_TARGET}getDefaults(){return Object.assign(super.getDefaults(),{attributes:{}})}getAttribute(e){return this.getRefMap("attributes",e)}setAttribute(e,t){return this.setRefMap("attributes",e,t,{usage:re.ARRAY_BUFFER})}listAttributes(){return this.listRefMapValues("attributes")}listSemantics(){return this.listRefMapKeys("attributes")}};function Q(){return Q=Object.assign?Object.assign.bind():function(o){for(var e=1;e<arguments.length;e++){var t=arguments[e];for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(o[r]=t[r])}return o},Q.apply(this,arguments)}let $t=class extends ee{init(){this.propertyType=m.SCENE}getDefaults(){return Object.assign(super.getDefaults(),{children:[]})}copy(e,t=me){if(t===me)throw new Error("Scene cannot be copied.");return super.copy(e,t)}addChild(e){e.u&&e.u.removeChild(e),this.addRef("children",e),e.h.add(this);const t=this[F].children;return t[t.length-1].addEventListener("dispose",()=>e.h.delete(this)),this}removeChild(e){return this.removeRef("children",e)}listChildren(){return this.listRefs("children")}traverse(e){for(const t of this.listChildren())t.traverse(e);return this}},Ys=class extends ee{init(){this.propertyType=m.SKIN}getDefaults(){return Object.assign(super.getDefaults(),{skeleton:null,inverseBindMatrices:null,joints:[]})}getSkeleton(){return this.getRef("skeleton")}setSkeleton(e){return this.setRef("skeleton",e)}getInverseBindMatrices(){return this.getRef("inverseBindMatrices")}setInverseBindMatrices(e){return this.setRef("inverseBindMatrices",e,{usage:re.INVERSE_BIND_MATRICES})}addJoint(e){return this.addRef("joints",e)}removeJoint(e){return this.removeRef("joints",e)}listJoints(){return this.listRefs("joints")}},et=class extends ee{init(){this.propertyType=m.TEXTURE}getDefaults(){return Object.assign(super.getDefaults(),{image:null,mimeType:"",uri:""})}getMimeType(){return this.get("mimeType")||he.extensionToMimeType(je.extension(this.get("uri")))}setMimeType(e){return this.set("mimeType",e)}getURI(){return this.get("uri")}setURI(e){this.set("uri",e);const t=he.extensionToMimeType(je.extension(e));return t&&this.set("mimeType",t),this}getImage(){return this.get("image")}setImage(e){return this.set("image",O.assertView(e))}getSize(){const e=this.get("image");return e?he.getSize(e,this.getMimeType()):null}},zt=class extends ee{init(){this.propertyType=m.ROOT}getDefaults(){return Object.assign(super.getDefaults(),{asset:{generator:`glTF-Transform ${Us}`,version:"2.0"},defaultScene:null,accessors:[],animations:[],buffers:[],cameras:[],materials:[],meshes:[],nodes:[],scenes:[],skins:[],textures:[]})}constructor(e){super(e),this.l=new Set,e.addEventListener("node:create",t=>{this.g(t.target)})}clone(){throw new Error("Root cannot be cloned.")}copy(e,t=me){if(t===me)throw new Error("Root cannot be copied.");this.set("asset",Q({},e.get("asset"))),this.setName(e.getName()),this.setExtras(Q({},e.getExtras())),this.setDefaultScene(e.getDefaultScene()?t(e.getDefaultScene()):null);for(const r of e.listRefMapKeys("extensions")){const s=e.getExtension(r);this.setExtension(r,t(s))}return this}g(e){return e instanceof $t?this.addRef("scenes",e):e instanceof Xs?this.addRef("nodes",e):e instanceof nt?this.addRef("cameras",e):e instanceof Ys?this.addRef("skins",e):e instanceof Hs?this.addRef("meshes",e):e instanceof Ze?this.addRef("materials",e):e instanceof et?this.addRef("textures",e):e instanceof Vs?this.addRef("animations",e):e instanceof _?this.addRef("accessors",e):e instanceof Gs&&this.addRef("buffers",e),this}getAsset(){return this.get("asset")}listExtensionsUsed(){return Array.from(this.l)}listExtensionsRequired(){return this.listExtensionsUsed().filter(e=>e.isRequired())}p(e){return this.l.add(e),this}m(e){return this.l.delete(e),this}listScenes(){return this.listRefs("scenes")}setDefaultScene(e){return this.setRef("defaultScene",e)}getDefaultScene(){return this.getRef("defaultScene")}listNodes(){return this.listRefs("nodes")}listCameras(){return this.listRefs("cameras")}listSkins(){return this.listRefs("skins")}listMeshes(){return this.listRefs("meshes")}listMaterials(){return this.listRefs("materials")}listTextures(){return this.listRefs("textures")}listAnimations(){return this.listRefs("animations")}listAccessors(){return this.listRefs("accessors")}listBuffers(){return this.listRefs("buffers")}},Ks=class dt{static fromGraph(e){return dt.v.get(e)||null}constructor(){this.T=new wr,this.S=new zt(this.T),this.M=xe.DEFAULT_INSTANCE,dt.v.set(this.T,this)}getRoot(){return this.S}getGraph(){return this.T}getLogger(){return this.M}setLogger(e){return this.M=e,this}clone(){return new dt().setLogger(this.M).merge(this)}merge(e){for(const n of e.getRoot().listExtensionsUsed()){const i=this.createExtension(n.constructor);n.isRequired()&&i.setRequired(!0)}const t=new Set,r=new Map;t.add(e.S),r.set(e.S,this.S);for(const n of e.T.listEdges())for(const i of[n.getParent(),n.getChild()]){if(t.has(i))continue;let a;a=i.propertyType===m.TEXTURE_INFO?i:new i.constructor(this.T),r.set(i,a),t.add(i)}const s=n=>{const i=r.get(n);if(!i)throw new Error("Could resolve property.");return i};for(const n of t){const i=r.get(n);if(!i)throw new Error("Could resolve property.");i.propertyType!==m.TEXTURE_INFO&&i.copy(n,s)}return this}async transform(...e){const t=e.map(r=>r.name);for(const r of e)await r(this,{stack:t});return this}createExtension(e){const t=e.EXTENSION_NAME;return this.getRoot().listExtensionsUsed().find(r=>r.extensionName===t)||new e(this)}createScene(e=""){return new $t(this.T,e)}createNode(e=""){return new Xs(this.T,e)}createCamera(e=""){return new nt(this.T,e)}createSkin(e=""){return new Ys(this.T,e)}createMesh(e=""){return new Hs(this.T,e)}createPrimitive(){return new Qe(this.T)}createPrimitiveTarget(e=""){return new $r(this.T,e)}createMaterial(e=""){return new Ze(this.T,e)}createTexture(e=""){return new et(this.T,e)}createAnimation(e=""){return new Vs(this.T,e)}createAnimationChannel(e=""){return new rt(this.T,e)}createAnimationSampler(e=""){return new Nt(this.T,e)}createAccessor(e="",t=null){return t||(t=this.getRoot().listBuffers()[0]),new _(this.T,e).setBuffer(t)}createBuffer(e=""){return new Gs(this.T,e)}};Ks.v=new WeakMap;let V=class{constructor(e){this.extensionName="",this.prereadTypes=[],this.prewriteTypes=[],this.readDependencies=[],this.writeDependencies=[],this.document=void 0,this.required=!1,this.properties=new Set,this.I=void 0,this.document=e,e.getRoot().p(this),this.I=r=>{const s=r,n=s.target;n instanceof k&&n.extensionName===this.extensionName&&(s.type==="node:create"&&this.N(n),s.type==="node:dispose"&&this.O(n))};const t=e.getGraph();t.addEventListener("node:create",this.I),t.addEventListener("node:dispose",this.I)}dispose(){this.document.getRoot().m(this);const e=this.document.getGraph();e.removeEventListener("node:create",this.I),e.removeEventListener("node:dispose",this.I);for(const t of this.properties)t.dispose()}static register(){}isRequired(){return this.required}setRequired(e){return this.required=e,this}listProperties(){return Array.from(this.properties)}N(e){return this.properties.add(e),this}O(e){return this.properties.delete(e),this}install(e,t){return this}preread(e,t){return this}prewrite(e,t){return this}};V.EXTENSION_NAME=void 0;let zr=class{constructor(e){this.jsonDoc=void 0,this.buffers=[],this.bufferViews=[],this.bufferViewBuffers=[],this.accessors=[],this.textures=[],this.textureInfos=new Map,this.materials=[],this.meshes=[],this.cameras=[],this.nodes=[],this.skins=[],this.animations=[],this.scenes=[],this.jsonDoc=e}setTextureInfo(e,t){this.textureInfos.set(e,t),t.texCoord!==void 0&&e.setTexCoord(t.texCoord),t.extras!==void 0&&e.setExtras(t.extras);const r=this.jsonDoc.json.textures[t.index];if(r.sampler===void 0)return;const s=this.jsonDoc.json.samplers[r.sampler];s.magFilter!==void 0&&e.setMagFilter(s.magFilter),s.minFilter!==void 0&&e.setMinFilter(s.minFilter),s.wrapS!==void 0&&e.setWrapS(s.wrapS),s.wrapT!==void 0&&e.setWrapT(s.wrapT)}};const ls={logger:xe.DEFAULT_INSTANCE,extensions:[],dependencies:{}};let Hr=class{static read(e,t=ls){const r=Q({},ls,t),{json:s}=e,n=new Ks().setLogger(r.logger);this.validate(e,r);const i=new zr(e),a=s.asset,u=n.getRoot().getAsset();a.copyright&&(u.copyright=a.copyright),a.extras&&(u.extras=a.extras),s.extras!==void 0&&n.getRoot().setExtras(Q({},s.extras));const g=s.extensionsUsed||[],p=s.extensionsRequired||[];for(const c of r.extensions)if(g.includes(c.EXTENSION_NAME)){const h=n.createExtension(c).setRequired(p.includes(c.EXTENSION_NAME));for(const f of h.readDependencies)h.install(f,r.dependencies[f])}const T=s.buffers||[];n.getRoot().listExtensionsUsed().filter(c=>c.prereadTypes.includes(m.BUFFER)).forEach(c=>c.preread(i,m.BUFFER)),i.buffers=T.map(c=>{const h=n.createBuffer(c.name);return c.extras&&h.setExtras(c.extras),c.uri&&c.uri.indexOf("__")!==0&&h.setURI(c.uri),h}),i.bufferViewBuffers=(s.bufferViews||[]).map((c,h)=>{if(!i.bufferViews[h]){const f=e.json.buffers[c.buffer];i.bufferViews[h]=O.toView(f.uri?e.resources[f.uri]:e.resources[Pe],c.byteOffset||0,c.byteLength)}return i.buffers[c.buffer]});const x=s.accessors||[];i.accessors=x.map(c=>{const h=n.createAccessor(c.name,i.bufferViewBuffers[c.bufferView]).setType(c.type);return c.extras&&h.setExtras(c.extras),c.normalized!==void 0&&h.setNormalized(c.normalized),c.bufferView===void 0||h.setArray(ht(c,i)),h});const R=s.images||[],E=s.textures||[];n.getRoot().listExtensionsUsed().filter(c=>c.prereadTypes.includes(m.TEXTURE)).forEach(c=>c.preread(i,m.TEXTURE)),i.textures=R.map(c=>{const h=n.createTexture(c.name);if(c.extras&&h.setExtras(c.extras),c.bufferView!==void 0){const f=s.bufferViews[c.bufferView],d=e.json.buffers[f.buffer],I=f.byteOffset||0,M=(d.uri?e.resources[d.uri]:e.resources[Pe]).slice(I,I+f.byteLength);h.setImage(M)}else c.uri!==void 0&&(h.setImage(e.resources[c.uri]),c.uri.indexOf("__")!==0&&h.setURI(c.uri));if(c.mimeType!==void 0)h.setMimeType(c.mimeType);else if(c.uri){const f=je.extension(c.uri);h.setMimeType(he.extensionToMimeType(f))}return h}),i.materials=(s.materials||[]).map(c=>{const h=n.createMaterial(c.name);c.extras&&h.setExtras(c.extras),c.alphaMode!==void 0&&h.setAlphaMode(c.alphaMode),c.alphaCutoff!==void 0&&h.setAlphaCutoff(c.alphaCutoff),c.doubleSided!==void 0&&h.setDoubleSided(c.doubleSided);const f=c.pbrMetallicRoughness||{};if(f.baseColorFactor!==void 0&&h.setBaseColorFactor(f.baseColorFactor),c.emissiveFactor!==void 0&&h.setEmissiveFactor(c.emissiveFactor),f.metallicFactor!==void 0&&h.setMetallicFactor(f.metallicFactor),f.roughnessFactor!==void 0&&h.setRoughnessFactor(f.roughnessFactor),f.baseColorTexture!==void 0){const d=f.baseColorTexture;h.setBaseColorTexture(i.textures[E[d.index].source]),i.setTextureInfo(h.getBaseColorTextureInfo(),d)}if(c.emissiveTexture!==void 0){const d=c.emissiveTexture;h.setEmissiveTexture(i.textures[E[d.index].source]),i.setTextureInfo(h.getEmissiveTextureInfo(),d)}if(c.normalTexture!==void 0){const d=c.normalTexture;h.setNormalTexture(i.textures[E[d.index].source]),i.setTextureInfo(h.getNormalTextureInfo(),d),c.normalTexture.scale!==void 0&&h.setNormalScale(c.normalTexture.scale)}if(c.occlusionTexture!==void 0){const d=c.occlusionTexture;h.setOcclusionTexture(i.textures[E[d.index].source]),i.setTextureInfo(h.getOcclusionTextureInfo(),d),c.occlusionTexture.strength!==void 0&&h.setOcclusionStrength(c.occlusionTexture.strength)}if(f.metallicRoughnessTexture!==void 0){const d=f.metallicRoughnessTexture;h.setMetallicRoughnessTexture(i.textures[E[d.index].source]),i.setTextureInfo(h.getMetallicRoughnessTextureInfo(),d)}return h});const A=s.meshes||[];n.getRoot().listExtensionsUsed().filter(c=>c.prereadTypes.includes(m.PRIMITIVE)).forEach(c=>c.preread(i,m.PRIMITIVE)),i.meshes=A.map(c=>{const h=n.createMesh(c.name);return c.extras&&h.setExtras(c.extras),c.weights!==void 0&&h.setWeights(c.weights),(c.primitives||[]).forEach(f=>{const d=n.createPrimitive();f.extras&&d.setExtras(f.extras),f.material!==void 0&&d.setMaterial(i.materials[f.material]),f.mode!==void 0&&d.setMode(f.mode);for(const[M,S]of Object.entries(f.attributes||{}))d.setAttribute(M,i.accessors[S]);f.indices!==void 0&&d.setIndices(i.accessors[f.indices]);const I=c.extras&&c.extras.targetNames||[];(f.targets||[]).forEach((M,S)=>{const N=I[S]||S.toString(),v=n.createPrimitiveTarget(N);for(const[b,U]of Object.entries(M))v.setAttribute(b,i.accessors[U]);d.addTarget(v)}),h.addPrimitive(d)}),h}),i.cameras=(s.cameras||[]).map(c=>{const h=n.createCamera(c.name).setType(c.type);if(c.extras&&h.setExtras(c.extras),c.type===nt.Type.PERSPECTIVE){const f=c.perspective;h.setYFov(f.yfov),h.setZNear(f.znear),f.zfar!==void 0&&h.setZFar(f.zfar),f.aspectRatio!==void 0&&h.setAspectRatio(f.aspectRatio)}else{const f=c.orthographic;h.setZNear(f.znear).setZFar(f.zfar).setXMag(f.xmag).setYMag(f.ymag)}return h});const l=s.nodes||[];n.getRoot().listExtensionsUsed().filter(c=>c.prereadTypes.includes(m.NODE)).forEach(c=>c.preread(i,m.NODE)),i.nodes=l.map(c=>{const h=n.createNode(c.name);if(c.extras&&h.setExtras(c.extras),c.translation!==void 0&&h.setTranslation(c.translation),c.rotation!==void 0&&h.setRotation(c.rotation),c.scale!==void 0&&h.setScale(c.scale),c.matrix!==void 0){const f=[0,0,0],d=[0,0,0,1],I=[1,1,1];j.decompose(c.matrix,f,d,I),h.setTranslation(f),h.setRotation(d),h.setScale(I)}return c.weights!==void 0&&h.setWeights(c.weights),h}),i.skins=(s.skins||[]).map(c=>{const h=n.createSkin(c.name);c.extras&&h.setExtras(c.extras),c.inverseBindMatrices!==void 0&&h.setInverseBindMatrices(i.accessors[c.inverseBindMatrices]),c.skeleton!==void 0&&h.setSkeleton(i.nodes[c.skeleton]);for(const f of c.joints)h.addJoint(i.nodes[f]);return h}),l.map((c,h)=>{const f=i.nodes[h];(c.children||[]).forEach(d=>f.addChild(i.nodes[d])),c.mesh!==void 0&&f.setMesh(i.meshes[c.mesh]),c.camera!==void 0&&f.setCamera(i.cameras[c.camera]),c.skin!==void 0&&f.setSkin(i.skins[c.skin])}),i.animations=(s.animations||[]).map(c=>{const h=n.createAnimation(c.name);c.extras&&h.setExtras(c.extras);const f=(c.samplers||[]).map(d=>{const I=n.createAnimationSampler().setInput(i.accessors[d.input]).setOutput(i.accessors[d.output]).setInterpolation(d.interpolation||Nt.Interpolation.LINEAR);return d.extras&&I.setExtras(d.extras),h.addSampler(I),I});return(c.channels||[]).forEach(d=>{const I=n.createAnimationChannel().setSampler(f[d.sampler]).setTargetPath(d.target.path);d.target.node!==void 0&&I.setTargetNode(i.nodes[d.target.node]),d.extras&&I.setExtras(d.extras),h.addChannel(I)}),h});const y=s.scenes||[];return n.getRoot().listExtensionsUsed().filter(c=>c.prereadTypes.includes(m.SCENE)).forEach(c=>c.preread(i,m.SCENE)),i.scenes=y.map(c=>{const h=n.createScene(c.name);return c.extras&&h.setExtras(c.extras),(c.nodes||[]).map(f=>i.nodes[f]).forEach(f=>h.addChild(f)),h}),s.scene!==void 0&&n.getRoot().setDefaultScene(i.scenes[s.scene]),n.getRoot().listExtensionsUsed().forEach(c=>c.read(i)),x.forEach((c,h)=>{const f=i.accessors[h],d=!!c.sparse,I=!c.bufferView&&!f.getArray();(d||I)&&f.setSparse(!0).setArray(function(M,S){const N=xt[M.componentType],v=_.getElementSize(M.type);let b;b=M.bufferView!==void 0?ht(M,S):new N(M.count*v);const U=M.sparse;if(!U)return b;const w=U.count,C=Q({},M,U.indices,{count:w,type:"SCALAR"}),D=Q({},M,U.values,{count:w}),q=ht(C,S),H=ht(D,S);for(let ne=0;ne<C.count;ne++)for(let Y=0;Y<v;Y++)b[q[ne]*v+Y]=H[ne*v+Y];return b}(c,i))}),n}static validate(e,t){const r=e.json;if(r.asset.version!=="2.0")throw new Error(`Unsupported glTF version, "${r.asset.version}".`);if(r.extensionsRequired){for(const s of r.extensionsRequired)if(!t.extensions.find(n=>n.EXTENSION_NAME===s))throw new Error(`Missing required extension, "${s}".`)}if(r.extensionsUsed)for(const s of r.extensionsUsed)t.extensions.find(n=>n.EXTENSION_NAME===s)||t.logger.warn(`Missing optional extension, "${s}".`)}};function ht(o,e){const t=e.bufferViews[o.bufferView],r=e.jsonDoc.json.bufferViews[o.bufferView],s=xt[o.componentType],n=_.getElementSize(o.type),i=s.BYTES_PER_ELEMENT;if(r.byteStride!==void 0&&r.byteStride!==n*i)return function(u,g){const p=g.bufferViews[u.bufferView],T=g.jsonDoc.json.bufferViews[u.bufferView],x=xt[u.componentType],R=_.getElementSize(u.type),E=x.BYTES_PER_ELEMENT,A=u.byteOffset||0,l=new x(u.count*R),y=new DataView(p.buffer,p.byteOffset,p.byteLength),c=T.byteStride;for(let h=0;h<u.count;h++)for(let f=0;f<R;f++){const d=A+h*c+f*E;let I;switch(u.componentType){case _.ComponentType.FLOAT:I=y.getFloat32(d,!0);break;case _.ComponentType.UNSIGNED_INT:I=y.getUint32(d,!0);break;case _.ComponentType.UNSIGNED_SHORT:I=y.getUint16(d,!0);break;case _.ComponentType.UNSIGNED_BYTE:I=y.getUint8(d);break;case _.ComponentType.SHORT:I=y.getInt16(d,!0);break;case _.ComponentType.BYTE:I=y.getInt8(d);break;default:throw new Error(`Unexpected componentType "${u.componentType}".`)}l[h*R+f]=I}return l}(o,e);const a=t.byteOffset+(o.byteOffset||0);return new s(t.buffer.slice(a,a+o.count*n*i))}var Je;(function(o){o[o.ARRAY_BUFFER=34962]="ARRAY_BUFFER",o[o.ELEMENT_ARRAY_BUFFER=34963]="ELEMENT_ARRAY_BUFFER"})(Je||(Je={}));let fe=class{constructor(e,t,r){this.C=void 0,this.jsonDoc=void 0,this.options=void 0,this.accessorIndexMap=new Map,this.animationIndexMap=new Map,this.bufferIndexMap=new Map,this.cameraIndexMap=new Map,this.skinIndexMap=new Map,this.materialIndexMap=new Map,this.meshIndexMap=new Map,this.nodeIndexMap=new Map,this.imageIndexMap=new Map,this.textureDefIndexMap=new Map,this.textureInfoDefMap=new Map,this.samplerDefIndexMap=new Map,this.sceneIndexMap=new Map,this.imageBufferViews=[],this.otherBufferViews=new Map,this.otherBufferViewsIndexMap=new Map,this.extensionData={},this.bufferURIGenerator=void 0,this.imageURIGenerator=void 0,this.logger=void 0,this.F=new Map,this.accessorUsageGroupedByParent=new Set(["ARRAY_BUFFER"]),this.accessorParents=new Map,this.C=e,this.jsonDoc=t,this.options=r;const s=e.getRoot(),n=s.listBuffers().length,i=s.listTextures().length;this.bufferURIGenerator=new hs(n>1,()=>r.basename||"buffer"),this.imageURIGenerator=new hs(i>1,a=>function(u,g){const p=u.getGraph().listParentEdges(g).find(T=>T.getParent()!==u.getRoot());return p?p.getName().replace(/texture$/i,""):""}(e,a)||r.basename||"texture"),this.logger=e.getLogger()}createTextureInfoDef(e,t){const r={magFilter:t.getMagFilter()||void 0,minFilter:t.getMinFilter()||void 0,wrapS:t.getWrapS(),wrapT:t.getWrapT()},s=JSON.stringify(r);this.samplerDefIndexMap.has(s)||(this.samplerDefIndexMap.set(s,this.jsonDoc.json.samplers.length),this.jsonDoc.json.samplers.push(r));const n={source:this.imageIndexMap.get(e),sampler:this.samplerDefIndexMap.get(s)},i=JSON.stringify(n);this.textureDefIndexMap.has(i)||(this.textureDefIndexMap.set(i,this.jsonDoc.json.textures.length),this.jsonDoc.json.textures.push(n));const a={index:this.textureDefIndexMap.get(i)};return t.getTexCoord()!==0&&(a.texCoord=t.getTexCoord()),Object.keys(t.getExtras()).length>0&&(a.extras=t.getExtras()),this.textureInfoDefMap.set(t,a),a}createPropertyDef(e){const t={};return e.getName()&&(t.name=e.getName()),Object.keys(e.getExtras()).length>0&&(t.extras=e.getExtras()),t}createAccessorDef(e){const t=this.createPropertyDef(e);return t.type=e.getType(),t.componentType=e.getComponentType(),t.count=e.getCount(),this.C.getGraph().listParentEdges(e).some(r=>r.getName()==="attributes"&&r.getAttributes().key==="POSITION"||r.getName()==="input")&&(t.max=e.getMax([]).map(Math.fround),t.min=e.getMin([]).map(Math.fround)),e.getNormalized()&&(t.normalized=e.getNormalized()),t}createImageData(e,t,r){if(this.options.format===_e.GLB)this.imageBufferViews.push(t),e.bufferView=this.jsonDoc.json.bufferViews.length,this.jsonDoc.json.bufferViews.push({buffer:0,byteOffset:-1,byteLength:t.byteLength});else{const s=he.mimeTypeToExtension(r.getMimeType());e.uri=this.imageURIGenerator.createURI(r,s),this.jsonDoc.resources[e.uri]=t}}getAccessorUsage(e){const t=this.F.get(e);if(t)return t;if(e.getSparse())return re.SPARSE;for(const r of this.C.getGraph().listParentEdges(e)){const{usage:s}=r.getAttributes();if(s)return s;r.getParent().propertyType!==m.ROOT&&this.logger.warn(`Missing attribute ".usage" on edge, "${r.getName()}".`)}return re.OTHER}addAccessorToUsageGroup(e,t){const r=this.F.get(e);if(r&&r!==t)throw new Error(`Accessor with usage "${r}" cannot be reused as "${t}".`);return this.F.set(e,t),this}listAccessorUsageGroups(){const e={};for(const[t,r]of Array.from(this.F.entries()))e[r]=e[r]||[],e[r].push(t);return e}};fe.BufferViewTarget=Je,fe.BufferViewUsage=re,fe.USAGE_TO_TARGET={[re.ARRAY_BUFFER]:Je.ARRAY_BUFFER,[re.ELEMENT_ARRAY_BUFFER]:Je.ELEMENT_ARRAY_BUFFER};let hs=class{constructor(e,t){this.multiple=void 0,this.basename=void 0,this.counter={},this.multiple=e,this.basename=t}createURI(e,t){if(e.getURI())return e.getURI();if(this.multiple){const r=this.basename(e);return this.counter[r]=this.counter[r]||1,`${r}_${this.counter[r]++}.${t}`}return`${this.basename(e)}.${t}`}};const{BufferViewUsage:ft}=fe,{UNSIGNED_INT:Xr,UNSIGNED_SHORT:qr,UNSIGNED_BYTE:Yr}=_.ComponentType;let Kr=class{static write(e,t){const r=e.getRoot(),s={asset:Q({generator:`glTF-Transform ${Us}`},r.getAsset()),extras:Q({},r.getExtras())},n={json:s,resources:{}},i=new fe(e,n,t),a=t.logger||xe.DEFAULT_INSTANCE,u=new Set(t.extensions.map(l=>l.EXTENSION_NAME)),g=e.getRoot().listExtensionsUsed().filter(l=>u.has(l.extensionName)),p=e.getRoot().listExtensionsRequired().filter(l=>u.has(l.extensionName));g.length<e.getRoot().listExtensionsUsed().length&&a.warn("Some extensions were not registered for I/O, and will not be written.");for(const l of g)for(const y of l.writeDependencies)l.install(y,t.dependencies[y]);function T(l,y,c,h){const f=[];let d=0;for(const M of l){const S=i.createAccessorDef(M);S.bufferView=s.bufferViews.length;const N=M.getArray(),v=O.pad(O.toView(N));S.byteOffset=d,d+=v.byteLength,f.push(v),i.accessorIndexMap.set(M,s.accessors.length),s.accessors.push(S)}const I={buffer:y,byteOffset:c,byteLength:O.concat(f).byteLength};return h&&(I.target=h),s.bufferViews.push(I),{buffers:f,byteLength:d}}function x(l,y,c){const h=l[0].getCount();let f=0;for(const S of l){const N=i.createAccessorDef(S);N.bufferView=s.bufferViews.length,N.byteOffset=f;const v=S.getElementSize(),b=S.getComponentSize();f+=O.padNumber(v*b),i.accessorIndexMap.set(S,s.accessors.length),s.accessors.push(N)}const d=h*f,I=new ArrayBuffer(d),M=new DataView(I);for(let S=0;S<h;S++){let N=0;for(const v of l){const b=v.getElementSize(),U=v.getComponentSize(),w=v.getComponentType(),C=v.getArray();for(let D=0;D<b;D++){const q=S*f+N+D*U,H=C[S*b+D];switch(w){case _.ComponentType.FLOAT:M.setFloat32(q,H,!0);break;case _.ComponentType.BYTE:M.setInt8(q,H);break;case _.ComponentType.SHORT:M.setInt16(q,H,!0);break;case _.ComponentType.UNSIGNED_BYTE:M.setUint8(q,H);break;case _.ComponentType.UNSIGNED_SHORT:M.setUint16(q,H,!0);break;case _.ComponentType.UNSIGNED_INT:M.setUint32(q,H,!0);break;default:throw new Error("Unexpected component type: "+w)}}N+=O.padNumber(b*U)}}return s.bufferViews.push({buffer:y,byteOffset:c,byteLength:d,byteStride:f,target:fe.BufferViewTarget.ARRAY_BUFFER}),{byteLength:d,buffers:[new Uint8Array(I)]}}function R(l,y,c){const h=[];let f=0;const d=new Map;let I=-1/0;for(const w of l){const C=i.createAccessorDef(w);s.accessors.push(C),i.accessorIndexMap.set(w,s.accessors.length-1);const D=[],q=[],H=[],ne=new Array(w.getElementSize()).fill(0);for(let K=0,ce=w.getCount();K<ce;K++)if(w.getElement(K,H),!j.eq(H,ne,0)){I=Math.max(K,I),D.push(K);for(let oe=0;oe<H.length;oe++)q.push(H[oe])}const Y=D.length,P={accessorDef:C,count:Y};if(d.set(w,P),Y===0)continue;if(Y>w.getCount()/3){const K=(100*D.length/w.getCount()).toFixed(1);a.warn(`Sparse accessor with many non-zero elements (${K}%) may increase file size.`)}const W=xt[w.getComponentType()];P.indices=D,P.values=new W(q)}if(!Number.isFinite(I))return{buffers:h,byteLength:f};const M=I<255?Uint8Array:I<65535?Uint16Array:Uint32Array,S=I<255?Yr:I<65535?qr:Xr,N={buffer:y,byteOffset:c+f,byteLength:0};for(const w of l){const C=d.get(w);if(C.count===0)continue;C.indicesByteOffset=N.byteLength;const D=O.pad(O.toView(new M(C.indices)));h.push(D),f+=D.byteLength,N.byteLength+=D.byteLength}s.bufferViews.push(N);const v=s.bufferViews.length-1,b={buffer:y,byteOffset:c+f,byteLength:0};for(const w of l){const C=d.get(w);if(C.count===0)continue;C.valuesByteOffset=b.byteLength;const D=O.pad(O.toView(C.values));h.push(D),f+=D.byteLength,b.byteLength+=D.byteLength}s.bufferViews.push(b);const U=s.bufferViews.length-1;for(const w of l){const C=d.get(w);C.count!==0&&(C.accessorDef.sparse={count:C.count,indices:{bufferView:v,byteOffset:C.indicesByteOffset,componentType:S},values:{bufferView:U,byteOffset:C.valuesByteOffset}})}return{buffers:h,byteLength:f}}const E=new Map;for(const l of e.getGraph().listEdges()){if(l.getParent()===r)continue;const y=l.getChild();if(y instanceof _){const c=E.get(y)||[];c.push(l),E.set(y,c)}}if(s.accessors=[],s.bufferViews=[],s.samplers=[],s.textures=[],s.images=r.listTextures().map((l,y)=>{const c=i.createPropertyDef(l);l.getMimeType()&&(c.mimeType=l.getMimeType());const h=l.getImage();return h&&i.createImageData(c,h,l),i.imageIndexMap.set(l,y),c}),g.filter(l=>l.prewriteTypes.includes(m.ACCESSOR)).forEach(l=>l.prewrite(i,m.ACCESSOR)),r.listAccessors().forEach(l=>{const y=i.accessorUsageGroupedByParent,c=i.accessorParents;if(i.accessorIndexMap.has(l))return;const h=E.get(l)||[],f=i.getAccessorUsage(l);if(i.addAccessorToUsageGroup(l,f),y.has(f)){const d=h[0].getParent(),I=c.get(d)||new Set;I.add(l),c.set(d,I)}}),g.filter(l=>l.prewriteTypes.includes(m.BUFFER)).forEach(l=>l.prewrite(i,m.BUFFER)),(r.listAccessors().length>0||r.listTextures().length>0||i.otherBufferViews.size>0)&&r.listBuffers().length===0)throw new Error("Buffer required for Document resources, but none was found.");s.buffers=[],r.listBuffers().forEach((l,y)=>{const c=i.createPropertyDef(l),h=i.accessorUsageGroupedByParent,f=i.accessorParents,d=l.listParents().filter(b=>b instanceof _),I=new Set(d),M=[],S=s.buffers.length;let N=0;const v=i.listAccessorUsageGroups();for(const b in v)if(h.has(b))for(const U of Array.from(f.values())){const w=Array.from(U).filter(C=>I.has(C)).filter(C=>i.getAccessorUsage(C)===b);if(w.length)if(b!==ft.ARRAY_BUFFER||t.vertexLayout===mt.INTERLEAVED){const C=b===ft.ARRAY_BUFFER?x(w,S,N):T(w,S,N);N+=C.byteLength,M.push(...C.buffers)}else for(const C of w){const D=x([C],S,N);N+=D.byteLength,M.push(...D.buffers)}}else{const U=v[b].filter(D=>I.has(D));if(!U.length)continue;const w=b===ft.ELEMENT_ARRAY_BUFFER?fe.BufferViewTarget.ELEMENT_ARRAY_BUFFER:void 0,C=b===ft.SPARSE?R(U,S,N):T(U,S,N,w);N+=C.byteLength,M.push(...C.buffers)}if(i.imageBufferViews.length&&y===0){for(let b=0;b<i.imageBufferViews.length;b++)if(s.bufferViews[s.images[b].bufferView].byteOffset=N,N+=i.imageBufferViews[b].byteLength,M.push(i.imageBufferViews[b]),N%8){const U=8-N%8;N+=U,M.push(new Uint8Array(U))}}if(i.otherBufferViews.has(l))for(const b of i.otherBufferViews.get(l))s.bufferViews.push({buffer:S,byteOffset:N,byteLength:b.byteLength}),i.otherBufferViewsIndexMap.set(b,s.bufferViews.length-1),N+=b.byteLength,M.push(b);if(N){let b;t.format===_e.GLB?b=Pe:(b=i.bufferURIGenerator.createURI(l,"bin"),c.uri=b),c.byteLength=N,n.resources[b]=O.concat(M)}s.buffers.push(c),i.bufferIndexMap.set(l,y)}),r.listAccessors().find(l=>!l.getBuffer())&&a.warn("Skipped writing one or more Accessors: no Buffer assigned."),s.materials=r.listMaterials().map((l,y)=>{const c=i.createPropertyDef(l);if(l.getAlphaMode()!==Ze.AlphaMode.OPAQUE&&(c.alphaMode=l.getAlphaMode()),l.getAlphaMode()===Ze.AlphaMode.MASK&&(c.alphaCutoff=l.getAlphaCutoff()),l.getDoubleSided()&&(c.doubleSided=!0),c.pbrMetallicRoughness={},j.eq(l.getBaseColorFactor(),[1,1,1,1])||(c.pbrMetallicRoughness.baseColorFactor=l.getBaseColorFactor()),j.eq(l.getEmissiveFactor(),[0,0,0])||(c.emissiveFactor=l.getEmissiveFactor()),l.getRoughnessFactor()!==1&&(c.pbrMetallicRoughness.roughnessFactor=l.getRoughnessFactor()),l.getMetallicFactor()!==1&&(c.pbrMetallicRoughness.metallicFactor=l.getMetallicFactor()),l.getBaseColorTexture()){const h=l.getBaseColorTexture(),f=l.getBaseColorTextureInfo();c.pbrMetallicRoughness.baseColorTexture=i.createTextureInfoDef(h,f)}if(l.getEmissiveTexture()){const h=l.getEmissiveTexture(),f=l.getEmissiveTextureInfo();c.emissiveTexture=i.createTextureInfoDef(h,f)}if(l.getNormalTexture()){const h=l.getNormalTexture(),f=l.getNormalTextureInfo(),d=i.createTextureInfoDef(h,f);l.getNormalScale()!==1&&(d.scale=l.getNormalScale()),c.normalTexture=d}if(l.getOcclusionTexture()){const h=l.getOcclusionTexture(),f=l.getOcclusionTextureInfo(),d=i.createTextureInfoDef(h,f);l.getOcclusionStrength()!==1&&(d.strength=l.getOcclusionStrength()),c.occlusionTexture=d}if(l.getMetallicRoughnessTexture()){const h=l.getMetallicRoughnessTexture(),f=l.getMetallicRoughnessTextureInfo();c.pbrMetallicRoughness.metallicRoughnessTexture=i.createTextureInfoDef(h,f)}return i.materialIndexMap.set(l,y),c}),s.meshes=r.listMeshes().map((l,y)=>{const c=i.createPropertyDef(l);let h=null;return c.primitives=l.listPrimitives().map(f=>{const d={attributes:{}};d.mode=f.getMode();const I=f.getMaterial();I&&(d.material=i.materialIndexMap.get(I)),Object.keys(f.getExtras()).length&&(d.extras=f.getExtras());const M=f.getIndices();M&&(d.indices=i.accessorIndexMap.get(M));for(const S of f.listSemantics())d.attributes[S]=i.accessorIndexMap.get(f.getAttribute(S));for(const S of f.listTargets()){const N={};for(const v of S.listSemantics())N[v]=i.accessorIndexMap.get(S.getAttribute(v));d.targets=d.targets||[],d.targets.push(N)}return f.listTargets().length&&!h&&(h=f.listTargets().map(S=>S.getName())),d}),l.getWeights().length&&(c.weights=l.getWeights()),h&&(c.extras=c.extras||{},c.extras.targetNames=h),i.meshIndexMap.set(l,y),c}),s.cameras=r.listCameras().map((l,y)=>{const c=i.createPropertyDef(l);if(c.type=l.getType(),c.type===nt.Type.PERSPECTIVE){c.perspective={znear:l.getZNear(),zfar:l.getZFar(),yfov:l.getYFov()};const h=l.getAspectRatio();h!==null&&(c.perspective.aspectRatio=h)}else c.orthographic={znear:l.getZNear(),zfar:l.getZFar(),xmag:l.getXMag(),ymag:l.getYMag()};return i.cameraIndexMap.set(l,y),c}),s.nodes=r.listNodes().map((l,y)=>{const c=i.createPropertyDef(l);return j.eq(l.getTranslation(),[0,0,0])||(c.translation=l.getTranslation()),j.eq(l.getRotation(),[0,0,0,1])||(c.rotation=l.getRotation()),j.eq(l.getScale(),[1,1,1])||(c.scale=l.getScale()),l.getWeights().length&&(c.weights=l.getWeights()),i.nodeIndexMap.set(l,y),c}),s.skins=r.listSkins().map((l,y)=>{const c=i.createPropertyDef(l),h=l.getInverseBindMatrices();h&&(c.inverseBindMatrices=i.accessorIndexMap.get(h));const f=l.getSkeleton();return f&&(c.skeleton=i.nodeIndexMap.get(f)),c.joints=l.listJoints().map(d=>i.nodeIndexMap.get(d)),i.skinIndexMap.set(l,y),c}),r.listNodes().forEach((l,y)=>{const c=s.nodes[y],h=l.getMesh();h&&(c.mesh=i.meshIndexMap.get(h));const f=l.getCamera();f&&(c.camera=i.cameraIndexMap.get(f));const d=l.getSkin();d&&(c.skin=i.skinIndexMap.get(d)),l.listChildren().length>0&&(c.children=l.listChildren().map(I=>i.nodeIndexMap.get(I)))}),s.animations=r.listAnimations().map((l,y)=>{const c=i.createPropertyDef(l),h=new Map;return c.samplers=l.listSamplers().map((f,d)=>{const I=i.createPropertyDef(f);return I.input=i.accessorIndexMap.get(f.getInput()),I.output=i.accessorIndexMap.get(f.getOutput()),I.interpolation=f.getInterpolation(),h.set(f,d),I}),c.channels=l.listChannels().map(f=>{const d=i.createPropertyDef(f);return d.sampler=h.get(f.getSampler()),d.target={node:i.nodeIndexMap.get(f.getTargetNode()),path:f.getTargetPath()},d}),i.animationIndexMap.set(l,y),c}),s.scenes=r.listScenes().map((l,y)=>{const c=i.createPropertyDef(l);return c.nodes=l.listChildren().map(h=>i.nodeIndexMap.get(h)),i.sceneIndexMap.set(l,y),c});const A=r.getDefaultScene();return A&&(s.scene=r.listScenes().indexOf(A)),s.extensionsUsed=g.map(l=>l.extensionName),s.extensionsRequired=p.map(l=>l.extensionName),g.forEach(l=>l.write(i)),function(l){const y=[];for(const c in l){const h=l[c];(Array.isArray(h)&&h.length===0||h===null||h===""||h&&typeof h=="object"&&Object.keys(h).length===0)&&y.push(c)}for(const c of y)delete l[c]}(s),n}};var Et;(function(o){o[o.JSON=1313821514]="JSON",o[o.BIN=5130562]="BIN"})(Et||(Et={}));let Wr=class{constructor(){this.M=xe.DEFAULT_INSTANCE,this.l=new Set,this.U={},this.P=mt.INTERLEAVED,this.lastReadBytes=0,this.lastWriteBytes=0}setLogger(e){return this.M=e,this}registerExtensions(e){for(const t of e)this.l.add(t),t.register();return this}registerDependencies(e){return Object.assign(this.U,e),this}setVertexLayout(e){return this.P=e,this}async read(e){return await this.readJSON(await this.readAsJSON(e))}async readAsJSON(e){const t=await this.readURI(e,"view");this.lastReadBytes=t.byteLength;const r=fs(t)?this.L(t):{json:JSON.parse(O.decodeText(t)),resources:{}};return await this.j(r,this.dirname(e)),this.D(r),r}async readJSON(e){return e=this._(e),this.D(e),Hr.read(e,{extensions:Array.from(this.l),dependencies:this.U,logger:this.M})}async binaryToJSON(e){const t=this.L(O.assertView(e));this.D(t);const r=t.json;if(r.buffers&&r.buffers.some(s=>function(n,i){return i.uri!==void 0&&!(i.uri in n.resources)}(t,s)))throw new Error("Cannot resolve external buffers with binaryToJSON().");if(r.images&&r.images.some(s=>function(n,i){return i.uri!==void 0&&!(i.uri in n.resources)&&i.bufferView===void 0}(t,s)))throw new Error("Cannot resolve external images with binaryToJSON().");return t}async readBinary(e){return this.readJSON(await this.binaryToJSON(O.assertView(e)))}async writeJSON(e,t={}){if(t.format===_e.GLB&&e.getRoot().listBuffers().length>1)throw new Error("GLB must have 0–1 buffers.");return Kr.write(e,{format:t.format||_e.GLTF,basename:t.basename||"",logger:this.M,vertexLayout:this.P,dependencies:Q({},this.U),extensions:Array.from(this.l)})}async writeBinary(e){const{json:t,resources:r}=await this.writeJSON(e,{format:_e.GLB}),s=new Uint32Array([1179937895,2,12]),n=JSON.stringify(t),i=O.pad(O.encodeText(n),32),a=O.toView(new Uint32Array([i.byteLength,1313821514])),u=O.concat([a,i]);s[s.length-1]+=u.byteLength;const g=Object.values(r)[0];if(!g||!g.byteLength)return O.concat([O.toView(s),u]);const p=O.pad(g,0),T=O.toView(new Uint32Array([p.byteLength,5130562])),x=O.concat([T,p]);return s[s.length-1]+=x.byteLength,O.concat([O.toView(s),u,x])}async j(e,t){var r=this;const s=[...e.json.images||[],...e.json.buffers||[]].map(async function(n){const i=n.uri;if(!i||i.match(/data:/))return Promise.resolve();e.resources[i]=await r.readURI(r.resolve(t,i),"view"),r.lastReadBytes+=e.resources[i].byteLength});await Promise.all(s)}D(e){function t(r){if(r.uri){if(r.uri in e.resources)O.assertView(e.resources[r.uri]);else if(r.uri.match(/data:/)){const s=`__${Vr()}.${je.extension(r.uri)}`;e.resources[s]=O.createBufferFromDataURI(r.uri),r.uri=s}}}(e.json.images||[]).forEach(r=>{if(r.bufferView===void 0&&r.uri===void 0)throw new Error("Missing resource URI or buffer view.");t(r)}),(e.json.buffers||[]).forEach(t)}_(e){const{images:t,buffers:r}=e.json;return e={json:Q({},e.json),resources:Q({},e.resources)},t&&(e.json.images=t.map(s=>Q({},s))),r&&(e.json.buffers=r.map(s=>Q({},s))),e}L(e){if(!fs(e))throw new Error("Invalid glTF 2.0 binary.");const t=new Uint32Array(e.buffer,e.byteOffset+12,2);if(t[1]!==Et.JSON)throw new Error("Missing required GLB JSON chunk.");const r=t[0],s=O.decodeText(O.toView(e,20,r)),n=JSON.parse(s),i=20+r;if(e.byteLength<=i)return{json:n,resources:{}};const a=new Uint32Array(e.buffer,e.byteOffset+i,2);if(a[1]!==Et.BIN)throw new Error("Expected GLB BIN in second chunk.");const u=O.toView(e,i+8,a[0]);return{json:n,resources:{[Pe]:u}}}};function fs(o){if(o.byteLength<3*Uint32Array.BYTES_PER_ELEMENT)return!1;const e=new Uint32Array(o.buffer,o.byteOffset,3);return e[0]===1179937895&&e[1]===2}let ki=class extends Wr{constructor(e=We.DEFAULT_INIT){super(),this.J=void 0,this.J=e}async readURI(e,t){const r=await fetch(e,this.J);switch(t){case"view":return new Uint8Array(await r.arrayBuffer());case"text":return r.text()}}resolve(e,t){return We.resolve(e,t)}dirname(e){return We.dirname(e)}};const Jr=0,Zr=0,Qr=0,en=2,tn=0,sn=163,rn=166,nn=0,on=2,an=1,cn=64,un=0;class ln{constructor(){this.vkFormat=un,this.typeSize=1,this.pixelWidth=0,this.pixelHeight=0,this.pixelDepth=0,this.layerCount=0,this.faceCount=1,this.supercompressionScheme=Jr,this.levels=[],this.dataFormatDescriptor=[{vendorId:Qr,descriptorType:Zr,descriptorBlockSize:0,versionNumber:en,colorModel:tn,colorPrimaries:an,transferFunction:on,flags:nn,texelBlockDimension:[0,0,0,0],bytesPlane:[0,0,0,0,0,0,0,0],samples:[]}],this.keyValue={},this.globalData=null}}class ke{constructor(e,t,r,s){this._dataView=void 0,this._littleEndian=void 0,this._offset=void 0,this._dataView=new DataView(e.buffer,e.byteOffset+t,r),this._littleEndian=s,this._offset=0}_nextUint8(){const e=this._dataView.getUint8(this._offset);return this._offset+=1,e}_nextUint16(){const e=this._dataView.getUint16(this._offset,this._littleEndian);return this._offset+=2,e}_nextUint32(){const e=this._dataView.getUint32(this._offset,this._littleEndian);return this._offset+=4,e}_nextUint64(){const e=this._dataView.getUint32(this._offset,this._littleEndian),t=this._dataView.getUint32(this._offset+4,this._littleEndian),r=e+2**32*t;return this._offset+=8,r}_nextInt32(){const e=this._dataView.getInt32(this._offset,this._littleEndian);return this._offset+=4,e}_nextUint8Array(e){const t=new Uint8Array(this._dataView.buffer,this._dataView.byteOffset+this._offset,e);return this._offset+=e,t}_skip(e){return this._offset+=e,this}_scan(e,t=0){const r=this._offset;let s=0;for(;this._dataView.getUint8(this._offset)!==t&&s<e;)s++,this._offset++;return s<e&&this._offset++,new Uint8Array(this._dataView.buffer,this._dataView.byteOffset+r,s)}}const J=[171,75,84,88,32,50,48,187,13,10,26,10];function gs(o){return typeof TextDecoder<"u"?new TextDecoder().decode(o):Buffer.from(o).toString("utf8")}function bt(o){const e=new Uint8Array(o.buffer,o.byteOffset,J.length);if(e[0]!==J[0]||e[1]!==J[1]||e[2]!==J[2]||e[3]!==J[3]||e[4]!==J[4]||e[5]!==J[5]||e[6]!==J[6]||e[7]!==J[7]||e[8]!==J[8]||e[9]!==J[9]||e[10]!==J[10]||e[11]!==J[11])throw new Error("Missing KTX 2.0 identifier.");const t=new ln,r=17*Uint32Array.BYTES_PER_ELEMENT,s=new ke(o,J.length,r,!0);t.vkFormat=s._nextUint32(),t.typeSize=s._nextUint32(),t.pixelWidth=s._nextUint32(),t.pixelHeight=s._nextUint32(),t.pixelDepth=s._nextUint32(),t.layerCount=s._nextUint32(),t.faceCount=s._nextUint32();const n=s._nextUint32();t.supercompressionScheme=s._nextUint32();const i=s._nextUint32(),a=s._nextUint32(),u=s._nextUint32(),g=s._nextUint32(),p=s._nextUint64(),T=s._nextUint64(),x=n*3*8,R=new ke(o,J.length+r,x,!0);for(let P=0;P<n;P++)t.levels.push({levelData:new Uint8Array(o.buffer,o.byteOffset+R._nextUint64(),R._nextUint64()),uncompressedByteLength:R._nextUint64()});const E=new ke(o,i,a,!0),A={vendorId:E._skip(4)._nextUint16(),descriptorType:E._nextUint16(),versionNumber:E._nextUint16(),descriptorBlockSize:E._nextUint16(),colorModel:E._nextUint8(),colorPrimaries:E._nextUint8(),transferFunction:E._nextUint8(),flags:E._nextUint8(),texelBlockDimension:[E._nextUint8(),E._nextUint8(),E._nextUint8(),E._nextUint8()],bytesPlane:[E._nextUint8(),E._nextUint8(),E._nextUint8(),E._nextUint8(),E._nextUint8(),E._nextUint8(),E._nextUint8(),E._nextUint8()],samples:[]},l=6,y=4,c=(A.descriptorBlockSize/4-l)/y;for(let P=0;P<c;P++){const W={bitOffset:E._nextUint16(),bitLength:E._nextUint8(),channelType:E._nextUint8(),samplePosition:[E._nextUint8(),E._nextUint8(),E._nextUint8(),E._nextUint8()],sampleLower:-1/0,sampleUpper:1/0};W.channelType&cn?(W.sampleLower=E._nextInt32(),W.sampleUpper=E._nextInt32()):(W.sampleLower=E._nextUint32(),W.sampleUpper=E._nextUint32()),A.samples[P]=W}t.dataFormatDescriptor.length=0,t.dataFormatDescriptor.push(A);const h=new ke(o,u,g,!0);for(;h._offset<g;){const P=h._nextUint32(),W=h._scan(P),K=gs(W);if(t.keyValue[K]=h._nextUint8Array(P-W.byteLength-1),K.match(/^ktx/i)){const oe=gs(t.keyValue[K]);t.keyValue[K]=oe.substring(0,oe.lastIndexOf("\0"))}const ce=P%4?4-P%4:0;h._skip(ce)}if(T<=0)return t;const f=new ke(o,p,T,!0),d=f._nextUint16(),I=f._nextUint16(),M=f._nextUint32(),S=f._nextUint32(),N=f._nextUint32(),v=f._nextUint32(),b=[];for(let P=0;P<n;P++)b.push({imageFlags:f._nextUint32(),rgbSliceByteOffset:f._nextUint32(),rgbSliceByteLength:f._nextUint32(),alphaSliceByteOffset:f._nextUint32(),alphaSliceByteLength:f._nextUint32()});const U=p+f._offset,w=U+M,C=w+S,D=C+N,q=new Uint8Array(o.buffer,o.byteOffset+U,M),H=new Uint8Array(o.buffer,o.byteOffset+w,S),ne=new Uint8Array(o.buffer,o.byteOffset+C,N),Y=new Uint8Array(o.buffer,o.byteOffset+D,v);return t.globalData={endpointCount:d,selectorCount:I,imageDescs:b,endpointsData:q,selectorsData:H,tablesData:ne,extendedData:Y},t}const Ht="EXT_mesh_gpu_instancing",Lt="EXT_meshopt_compression",Ws="KHR_draco_mesh_compression",Xt="KHR_lights_punctual",qt="KHR_materials_anisotropy",Yt="KHR_materials_clearcoat",Kt="KHR_materials_emissive_strength",Wt="KHR_materials_ior",Jt="KHR_materials_iridescence",Zt="KHR_materials_pbrSpecularGlossiness",Qt="KHR_materials_sheen",es="KHR_materials_specular",ts="KHR_materials_transmission",ss="KHR_materials_unlit",rs="KHR_materials_volume",ve="KHR_materials_variants",ns="KHR_texture_transform",yt="KHR_xmp_json_ld",Bt="INSTANCE_ATTRIBUTE";class Js extends k{init(){this.extensionName=Ht,this.propertyType="InstancedMesh",this.parentTypes=[m.NODE]}getDefaults(){return Object.assign(super.getDefaults(),{attributes:{}})}getAttribute(e){return this.getRefMap("attributes",e)}setAttribute(e,t){return this.setRefMap("attributes",e,t,{usage:Bt})}listAttributes(){return this.listRefMapValues("attributes")}listSemantics(){return this.listRefMapKeys("attributes")}}Js.EXTENSION_NAME=Ht;const Te=Ht;class hn extends V{constructor(...e){super(...e),this.extensionName=Te,this.provideTypes=[m.NODE],this.prewriteTypes=[m.ACCESSOR]}createInstancedMesh(){return new Js(this.document.getGraph())}read(e){return(e.jsonDoc.json.nodes||[]).forEach((t,r)=>{if(!t.extensions||!t.extensions[Te])return;const s=t.extensions[Te],n=this.createInstancedMesh();for(const i in s.attributes)n.setAttribute(i,e.accessors[s.attributes[i]]);e.nodes[r].setExtension(Te,n)}),this}prewrite(e){e.accessorUsageGroupedByParent.add(Bt);for(const t of this.properties)for(const r of t.listAttributes())e.addAccessorToUsageGroup(r,Bt);return this}write(e){const t=e.jsonDoc;return this.document.getRoot().listNodes().forEach(r=>{const s=r.getExtension(Te);if(s){const n=e.nodeIndexMap.get(r),i=t.json.nodes[n],a={attributes:{}};s.listSemantics().forEach(u=>{const g=s.getAttribute(u);a.attributes[u]=e.accessorIndexMap.get(g)}),i.extensions=i.extensions||{},i.extensions[Te]=a}}),this}}function de(){return de=Object.assign?Object.assign.bind():function(o){for(var e=1;e<arguments.length;e++){var t=arguments[e];for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(o[r]=t[r])}return o},de.apply(this,arguments)}var tt,Le,$;hn.EXTENSION_NAME=Te,function(o){o.QUANTIZE="quantize",o.FILTER="filter"}(tt||(tt={})),function(o){o.ATTRIBUTES="ATTRIBUTES",o.TRIANGLES="TRIANGLES",o.INDICES="INDICES"}(Le||(Le={})),function(o){o.NONE="NONE",o.OCTAHEDRAL="OCTAHEDRAL",o.QUATERNION="QUATERNION",o.EXPONENTIAL="EXPONENTIAL"}($||($={}));const{BYTE:fn,SHORT:ps,FLOAT:gn}=_.ComponentType,{encodeNormalizedInt:ds,decodeNormalizedInt:wt}=j;function pn(o,e,t,r){const{filter:s,bits:n}=r,i={array:o.getArray(),byteStride:o.getElementSize()*o.getComponentSize(),componentType:o.getComponentType(),normalized:o.getNormalized()};if(t!==Le.ATTRIBUTES)return i;if(s!==$.NONE){let a=o.getNormalized()?function(u){const g=u.getComponentType(),p=u.getArray(),T=new Float32Array(p.length);for(let x=0;x<p.length;x++)T[x]=wt(p[x],g);return T}(o):new Float32Array(i.array);switch(s){case $.EXPONENTIAL:i.byteStride=4*o.getElementSize(),i.componentType=gn,i.normalized=!1,i.array=e.encodeFilterExp(a,o.getCount(),i.byteStride,n);break;case $.OCTAHEDRAL:i.byteStride=n>8?8:4,i.componentType=n>8?ps:fn,i.normalized=!0,a=o.getElementSize()===3?function(u){const g=new Float32Array(4*u.length/3);for(let p=0,T=u.length/3;p<T;p++)g[4*p]=u[3*p],g[4*p+1]=u[3*p+1],g[4*p+2]=u[3*p+2];return g}(a):a,i.array=e.encodeFilterOct(a,o.getCount(),i.byteStride,n);break;case $.QUATERNION:i.byteStride=8,i.componentType=ps,i.normalized=!0,i.array=e.encodeFilterQuat(a,o.getCount(),i.byteStride,n);break;default:throw new Error("Invalid filter.")}i.min=o.getMin([]),i.max=o.getMax([]),o.getNormalized()&&(i.min=i.min.map(u=>wt(u,o.getComponentType())),i.max=i.max.map(u=>wt(u,o.getComponentType()))),i.normalized&&(i.min=i.min.map(u=>ds(u,i.componentType)),i.max=i.max.map(u=>ds(u,i.componentType)))}else i.byteStride%4&&(i.array=function(a,u){const g=O.padNumber(a.BYTES_PER_ELEMENT*u)/a.BYTES_PER_ELEMENT,p=new a.constructor(a.length/u*g);for(let T=0;T*u<a.length;T++)for(let x=0;x<u;x++)p[T*g+x]=a[T*u+x];return p}(i.array,o.getElementSize()),i.byteStride=i.array.byteLength/o.getCount());return i}function dn(o,e){return e===fe.BufferViewUsage.ELEMENT_ARRAY_BUFFER?o.listParents().some(t=>t instanceof Qe&&t.getMode()===Qe.Mode.TRIANGLES)?Le.TRIANGLES:Le.INDICES:Le.ATTRIBUTES}function mn(o,e){const t=e.getGraph().listParentEdges(o).filter(r=>!(r.getParent()instanceof zt));for(const r of t){const s=r.getName(),n=r.getAttributes().key||"";if(s==="indices")return{filter:$.NONE};if(s==="attributes"){if(n==="POSITION")return{filter:$.NONE};if(n==="TEXCOORD_0")return{filter:$.NONE};if(n==="NORMAL")return{filter:$.OCTAHEDRAL,bits:8};if(n==="TANGENT")return{filter:$.OCTAHEDRAL,bits:8};if(n.startsWith("JOINTS_"))return{filter:$.NONE};if(n.startsWith("WEIGHTS_"))return{filter:$.NONE}}if(s==="output"){const i=Zs(o);return i==="rotation"?{filter:$.QUATERNION,bits:16}:i==="translation"||i==="scale"?{filter:$.EXPONENTIAL,bits:12}:{filter:$.NONE}}if(s==="input")return{filter:$.NONE};if(s==="inverseBindMatrices")return{filter:$.NONE}}return{filter:$.NONE}}function Zs(o){for(const e of o.listParents())if(e instanceof Nt){for(const t of e.listParents())if(t instanceof rt)return t.getTargetPath()}return null}const Z=Lt,ms={method:tt.QUANTIZE};class xs extends V{constructor(...e){super(...e),this.extensionName=Z,this.prereadTypes=[m.BUFFER,m.PRIMITIVE],this.prewriteTypes=[m.BUFFER,m.ACCESSOR],this.readDependencies=["meshopt.decoder"],this.writeDependencies=["meshopt.encoder"],this._decoder=null,this._decoderFallbackBufferMap=new Map,this._encoder=null,this._encoderOptions=ms,this._encoderFallbackBuffer=null,this._encoderBufferViews={},this._encoderBufferViewData={},this._encoderBufferViewAccessors={}}install(e,t){return e==="meshopt.decoder"&&(this._decoder=t),e==="meshopt.encoder"&&(this._encoder=t),this}setEncoderOptions(e){return this._encoderOptions=de({},ms,e),this}preread(e,t){if(!this._decoder){if(!this.isRequired())return this;throw new Error(`[${Z}] Please install extension dependency, "meshopt.decoder".`)}if(!this._decoder.supported){if(!this.isRequired())return this;throw new Error(`[${Z}]: Missing WASM support.`)}return t===m.BUFFER?this._prereadBuffers(e):t===m.PRIMITIVE&&this._prereadPrimitives(e),this}_prereadBuffers(e){const t=e.jsonDoc;(t.json.bufferViews||[]).forEach((r,s)=>{if(!r.extensions||!r.extensions[Z])return;const n=r.extensions[Z],i=n.byteOffset||0,a=n.byteLength||0,u=n.count,g=n.byteStride,p=new Uint8Array(u*g),T=t.json.buffers[n.buffer],x=O.toView(T.uri?t.resources[T.uri]:t.resources[Pe],i,a);this._decoder.decodeGltfBuffer(p,u,g,x,n.mode,n.filter),e.bufferViews[s]=p})}_prereadPrimitives(e){const t=e.jsonDoc;(t.json.bufferViews||[]).forEach(r=>{var s;r.extensions&&r.extensions[Z]&&(s=t.json.buffers[r.buffer]).extensions&&s.extensions[Lt]&&s.extensions[Lt].fallback&&this._decoderFallbackBufferMap.set(e.buffers[r.buffer],e.buffers[r.extensions[Z].buffer])})}read(e){if(!this.isRequired())return this;for(const[t,r]of this._decoderFallbackBufferMap){for(const s of t.listParents())s instanceof _&&s.swap(t,r);t.dispose()}return this}prewrite(e,t){return t===m.ACCESSOR?this._prewriteAccessors(e):t===m.BUFFER&&this._prewriteBuffers(e),this}_prewriteAccessors(e){const t=e.jsonDoc.json,r=this._encoder,s=this._encoderOptions,n=this.document.createBuffer(),i=this.document.getRoot().listBuffers().indexOf(n);this._encoderFallbackBuffer=n,this._encoderBufferViews={},this._encoderBufferViewData={},this._encoderBufferViewAccessors={};for(const a of this.document.getRoot().listAccessors()){if(Zs(a)==="weights"||a.getSparse())continue;const u=e.getAccessorUsage(a),g=dn(a,u),p=s.method===tt.FILTER?mn(a,this.document):{filter:$.NONE},T=pn(a,r,g,p),{array:x,byteStride:R}=T,E=a.getBuffer();if(!E)throw new Error(`${Z}: Missing buffer for accessor.`);const A=this.document.getRoot().listBuffers().indexOf(E),l=[u,g,p.filter,R,A].join(":");let y=this._encoderBufferViews[l],c=this._encoderBufferViewData[l],h=this._encoderBufferViewAccessors[l];y&&c||(h=this._encoderBufferViewAccessors[l]=[],c=this._encoderBufferViewData[l]=[],y=this._encoderBufferViews[l]={buffer:i,target:fe.USAGE_TO_TARGET[u],byteOffset:0,byteLength:0,byteStride:u===fe.BufferViewUsage.ARRAY_BUFFER?R:void 0,extensions:{[Z]:{buffer:A,byteOffset:0,byteLength:0,mode:g,filter:p.filter!==$.NONE?p.filter:void 0,byteStride:R,count:0}}});const f=e.createAccessorDef(a);f.componentType=T.componentType,f.normalized=T.normalized,f.byteOffset=y.byteLength,f.min&&T.min&&(f.min=T.min),f.max&&T.max&&(f.max=T.max),e.accessorIndexMap.set(a,t.accessors.length),t.accessors.push(f),h.push(f),c.push(new Uint8Array(x.buffer,x.byteOffset,x.byteLength)),y.byteLength+=x.byteLength,y.extensions.EXT_meshopt_compression.count+=a.getCount()}}_prewriteBuffers(e){const t=this._encoder;for(const r in this._encoderBufferViews){const s=this._encoderBufferViews[r],n=this._encoderBufferViewData[r],i=this.document.getRoot().listBuffers()[s.extensions[Z].buffer],a=e.otherBufferViews.get(i)||[],{count:u,byteStride:g,mode:p}=s.extensions[Z],T=O.concat(n),x=t.encodeGltfBuffer(T,u,g,p),R=O.pad(x);s.extensions[Z].byteLength=x.byteLength,n.length=0,n.push(R),a.push(R),e.otherBufferViews.set(i,a)}}write(e){let t=0;for(const i in this._encoderBufferViews){const a=this._encoderBufferViews[i],u=e.otherBufferViewsIndexMap.get(this._encoderBufferViewData[i][0]),g=this._encoderBufferViewAccessors[i];for(const x of g)x.bufferView=u;const p=e.jsonDoc.json.bufferViews[u],T=p.byteOffset||0;Object.assign(p,a),p.byteOffset=t,p.extensions[Z].byteOffset=T,t+=O.padNumber(a.byteLength)}const r=this._encoderFallbackBuffer,s=e.bufferIndexMap.get(r),n=e.jsonDoc.json.buffers[s];return n.byteLength=t,n.extensions={[Z]:{fallback:!0}},r.dispose(),this}}xs.EXTENSION_NAME=Z,xs.EncoderMethod=tt;const Xe="EXT_texture_avif";class xn{match(e){return e.length>=12&&O.decodeText(e.slice(4,12))==="ftypavif"}getSize(e){if(!this.match(e))return null;const t=new DataView(e.buffer,e.byteOffset,e.byteLength);let r=Ts(t,0);if(!r)return null;let s=r.end;for(;r=Ts(t,s);)if(r.type==="meta")s=r.start+4;else if(r.type==="iprp"||r.type==="ipco")s=r.start;else{if(r.type==="ispe")return[t.getUint32(r.start+4),t.getUint32(r.start+8)];if(r.type==="mdat")break;s=r.end}return null}getChannels(e){return 4}}class Tn extends V{constructor(...e){super(...e),this.extensionName=Xe,this.prereadTypes=[m.TEXTURE]}static register(){he.registerFormat("image/avif",new xn)}preread(e){return(e.jsonDoc.json.textures||[]).forEach(t=>{t.extensions&&t.extensions[Xe]&&(t.source=t.extensions[Xe].source)}),this}read(e){return this}write(e){const t=e.jsonDoc;return this.document.getRoot().listTextures().forEach(r=>{if(r.getMimeType()==="image/avif"){const s=e.imageIndexMap.get(r);(t.json.textures||[]).forEach(n=>{n.source===s&&(n.extensions=n.extensions||{},n.extensions[Xe]={source:n.source},delete n.source)})}}),this}}function Ts(o,e){if(o.byteLength<4+e)return null;const t=o.getUint32(e);return o.byteLength<t+e||t<8?null:{type:O.decodeText(new Uint8Array(o.buffer,o.byteOffset+e+4,4)),start:e+8,end:e+t}}Tn.EXTENSION_NAME=Xe;const qe="EXT_texture_webp";class En{match(e){return e.length>=12&&e[8]===87&&e[9]===69&&e[10]===66&&e[11]===80}getSize(e){const t=O.decodeText(e.slice(0,4)),r=O.decodeText(e.slice(8,12));if(t!=="RIFF"||r!=="WEBP")return null;const s=new DataView(e.buffer,e.byteOffset);let n=12;for(;n<s.byteLength;){const i=O.decodeText(new Uint8Array([s.getUint8(n),s.getUint8(n+1),s.getUint8(n+2),s.getUint8(n+3)])),a=s.getUint32(n+4,!0);if(i==="VP8 ")return[16383&s.getInt16(n+14,!0),16383&s.getInt16(n+16,!0)];if(i==="VP8L"){const u=s.getUint8(n+9),g=s.getUint8(n+10),p=s.getUint8(n+11);return[1+((63&g)<<8|u),1+((15&s.getUint8(n+12))<<10|p<<2|(192&g)>>6)]}n+=8+a+a%2}return null}getChannels(e){return 4}}class yn extends V{constructor(...e){super(...e),this.extensionName=qe,this.prereadTypes=[m.TEXTURE]}static register(){he.registerFormat("image/webp",new En)}preread(e){return(e.jsonDoc.json.textures||[]).forEach(t=>{t.extensions&&t.extensions[qe]&&(t.source=t.extensions[qe].source)}),this}read(e){return this}write(e){const t=e.jsonDoc;return this.document.getRoot().listTextures().forEach(r=>{if(r.getMimeType()==="image/webp"){const s=e.imageIndexMap.get(r);(t.json.textures||[]).forEach(n=>{n.source===s&&(n.extensions=n.extensions||{},n.extensions[qe]={source:n.source},delete n.source)})}}),this}}yn.EXTENSION_NAME=qe;const Es=Ws;let X,Qs,er,te;function Rn(o,e){const t=new X.DecoderBuffer;try{if(t.Init(e,e.length),o.GetEncodedGeometryType(t)!==X.TRIANGULAR_MESH)throw new Error(`[${Es}] Unknown geometry type.`);const r=new X.Mesh;if(!o.DecodeBufferToMesh(t,r).ok()||r.ptr===0)throw new Error(`[${Es}] Decoding failure.`);return r}finally{X.destroy(t)}}function In(o,e){const t=3*e.num_faces();let r,s;if(e.num_points()<=65534){const n=t*Uint16Array.BYTES_PER_ELEMENT;r=X._malloc(n),o.GetTrianglesUInt16Array(e,n,r),s=new Uint16Array(X.HEAPU16.buffer,r,t).slice()}else{const n=t*Uint32Array.BYTES_PER_ELEMENT;r=X._malloc(n),o.GetTrianglesUInt32Array(e,n,r),s=new Uint32Array(X.HEAPU32.buffer,r,t).slice()}return X._free(r),s}function An(o,e,t,r){const s=er[r.componentType],n=Qs[r.componentType],i=t.num_components(),a=e.num_points()*i,u=a*n.BYTES_PER_ELEMENT,g=X._malloc(u);o.GetAttributeDataArrayForAllPoints(e,t,s,u,g);const p=new n(X.HEAPF32.buffer,g,a).slice();return X._free(g),p}var st,ie;(function(o){o[o.EDGEBREAKER=1]="EDGEBREAKER",o[o.SEQUENTIAL=0]="SEQUENTIAL"})(st||(st={})),function(o){o.POSITION="POSITION",o.NORMAL="NORMAL",o.COLOR="COLOR",o.TEX_COORD="TEX_COORD",o.GENERIC="GENERIC"}(ie||(ie={}));const tr={[ie.POSITION]:14,[ie.NORMAL]:10,[ie.COLOR]:8,[ie.TEX_COORD]:12,[ie.GENERIC]:12},ys={decodeSpeed:5,encodeSpeed:5,method:st.EDGEBREAKER,quantizationBits:tr,quantizationVolume:"mesh"};function Nn(o,e=ys){const t=de({},ys,e);t.quantizationBits=de({},tr,e.quantizationBits);const r=new te.MeshBuilder,s=new te.Mesh,n=new te.ExpertEncoder(s),i={},a=new te.DracoInt8Array,u=o.listTargets().length>0;let g=!1;for(const A of o.listSemantics()){const l=o.getAttribute(A);if(l.getSparse()){g=!0;continue}const y=Sn(A),c=Mn(r,l.getComponentType(),s,te[y],l.getCount(),l.getElementSize(),l.getArray());if(c===-1)throw new Error(`Error compressing "${A}" attribute.`);if(i[A]=c,t.quantizationVolume==="mesh"||A!=="POSITION")n.SetAttributeQuantization(te[y],t.quantizationBits[y]);else{if(typeof t.quantizationVolume!="object")throw new Error("Invalid quantization volume state.");{const{quantizationVolume:h}=t,f=Math.max(h.max[0]-h.min[0],h.max[1]-h.min[1],h.max[2]-h.min[2]);n.SetAttributeExplicitQuantization(te[y],t.quantizationBits[y],l.getElementSize(),h.min,f)}}}const p=o.getIndices();if(!p)throw new Pt("Primitive must have indices.");r.AddFacesToMesh(s,p.getCount()/3,p.getArray()),n.SetSpeedOptions(t.encodeSpeed,t.decodeSpeed),n.SetTrackEncodedProperties(!0),n.SetEncodingMethod(t.method===st.SEQUENTIAL||u||g?te.MESH_SEQUENTIAL_ENCODING:te.MESH_EDGEBREAKER_ENCODING);const T=n.EncodeToDracoBuffer(!(u||g),a);if(T<=0)throw new Pt("Error applying Draco compression.");const x=new Uint8Array(T);for(let A=0;A<T;++A)x[A]=a.GetValue(A);const R=n.GetNumberOfEncodedPoints(),E=3*n.GetNumberOfEncodedFaces();return te.destroy(a),te.destroy(s),te.destroy(r),te.destroy(n),{numVertices:R,numIndices:E,data:x,attributeIDs:i}}function Sn(o){return o==="POSITION"?ie.POSITION:o==="NORMAL"?ie.NORMAL:o.startsWith("COLOR_")?ie.COLOR:o.startsWith("TEXCOORD_")?ie.TEX_COORD:ie.GENERIC}function Mn(o,e,t,r,s,n,i){switch(e){case _.ComponentType.UNSIGNED_BYTE:return o.AddUInt8Attribute(t,r,s,n,i);case _.ComponentType.BYTE:return o.AddInt8Attribute(t,r,s,n,i);case _.ComponentType.UNSIGNED_SHORT:return o.AddUInt16Attribute(t,r,s,n,i);case _.ComponentType.SHORT:return o.AddInt16Attribute(t,r,s,n,i);case _.ComponentType.UNSIGNED_INT:return o.AddUInt32Attribute(t,r,s,n,i);case _.ComponentType.FLOAT:return o.AddFloatAttribute(t,r,s,n,i);default:throw new Error(`Unexpected component type, "${e}".`)}}class Pt extends Error{}const G=Ws;class Rs extends V{constructor(...e){super(...e),this.extensionName=G,this.prereadTypes=[m.PRIMITIVE],this.prewriteTypes=[m.ACCESSOR],this.readDependencies=["draco3d.decoder"],this.writeDependencies=["draco3d.encoder"],this._decoderModule=null,this._encoderModule=null,this._encoderOptions={}}install(e,t){return e==="draco3d.decoder"&&(this._decoderModule=t,X=this._decoderModule,Qs={[_.ComponentType.FLOAT]:Float32Array,[_.ComponentType.UNSIGNED_INT]:Uint32Array,[_.ComponentType.UNSIGNED_SHORT]:Uint16Array,[_.ComponentType.UNSIGNED_BYTE]:Uint8Array,[_.ComponentType.SHORT]:Int16Array,[_.ComponentType.BYTE]:Int8Array},er={[_.ComponentType.FLOAT]:X.DT_FLOAT32,[_.ComponentType.UNSIGNED_INT]:X.DT_UINT32,[_.ComponentType.UNSIGNED_SHORT]:X.DT_UINT16,[_.ComponentType.UNSIGNED_BYTE]:X.DT_UINT8,[_.ComponentType.SHORT]:X.DT_INT16,[_.ComponentType.BYTE]:X.DT_INT8}),e==="draco3d.encoder"&&(this._encoderModule=t,te=this._encoderModule),this}setEncoderOptions(e){return this._encoderOptions=e,this}preread(e){if(!this._decoderModule)throw new Error(`[${G}] Please install extension dependency, "draco3d.decoder".`);const t=this.document.getLogger(),r=e.jsonDoc,s=new Map;try{const n=r.json.meshes||[];for(const i of n)for(const a of i.primitives){if(!a.extensions||!a.extensions[G])continue;const u=a.extensions[G];let[g,p]=s.get(u.bufferView)||[];if(!p||!g){const T=r.json.bufferViews[u.bufferView],x=r.json.buffers[T.buffer],R=O.toView(x.uri?r.resources[x.uri]:r.resources[Pe],T.byteOffset||0,T.byteLength);g=new this._decoderModule.Decoder,p=Rn(g,R),s.set(u.bufferView,[g,p]),t.debug(`[${G}] Decompressed ${R.byteLength} bytes.`)}for(const T in a.attributes){const x=e.jsonDoc.json.accessors[a.attributes[T]],R=g.GetAttributeByUniqueId(p,u.attributes[T]),E=An(g,p,R,x);e.accessors[a.attributes[T]].setArray(E)}a.indices!==void 0&&e.accessors[a.indices].setArray(In(g,p))}}finally{for(const[n,i]of Array.from(s.values()))this._decoderModule.destroy(n),this._decoderModule.destroy(i)}return this}read(e){return this}prewrite(e,t){if(!this._encoderModule)throw new Error(`[${G}] Please install extension dependency, "draco3d.encoder".`);const r=this.document.getLogger();r.debug(`[${G}] Compression options: ${JSON.stringify(this._encoderOptions)}`);const s=function(a){const u=a.getLogger(),g=new Set,p=new Set;for(const l of a.getRoot().listMeshes())for(const y of l.listPrimitives())y.getIndices()?y.getMode()!==Qe.Mode.TRIANGLES?(p.add(y),u.warn(`[${G}] Skipping Draco compression on non-TRIANGLES primitive.`)):g.add(y):(p.add(y),u.warn(`[${G}] Skipping Draco compression on non-indexed primitive.`));const T=a.getRoot().listAccessors(),x=new Map;for(let l=0;l<T.length;l++)x.set(T[l],l);const R=new Map,E=new Set,A=new Map;for(const l of Array.from(g)){let y=Is(l,x);if(E.has(y))A.set(l,y);else{if(R.has(l.getIndices())){const c=l.getIndices(),h=c.clone();x.set(h,a.getRoot().listAccessors().length-1),l.swap(c,h)}for(const c of l.listAttributes())if(R.has(c)){const h=c.clone();x.set(h,a.getRoot().listAccessors().length-1),l.swap(c,h)}y=Is(l,x),E.add(y),A.set(l,y),R.set(l.getIndices(),y);for(const c of l.listAttributes())R.set(c,y)}}for(const l of Array.from(R.keys())){const y=new Set(l.listParents().map(c=>c.propertyType));if(y.size!==2||!y.has(m.PRIMITIVE)||!y.has(m.ROOT))throw new Error(`[${G}] Compressed accessors must only be used as indices or vertex attributes.`)}for(const l of Array.from(g)){const y=A.get(l),c=l.getIndices();if(R.get(c)!==y||l.listAttributes().some(h=>R.get(h)!==y))throw new Error(`[${G}] Draco primitives must share all, or no, accessors.`)}for(const l of Array.from(p)){const y=l.getIndices();if(R.has(y)||l.listAttributes().some(c=>R.has(c)))throw new Error(`[${G}] Accessor cannot be shared by compressed and uncompressed primitives.`)}return A}(this.document),n=new Map;let i="mesh";this._encoderOptions.quantizationVolume==="scene"&&(this.document.getRoot().listScenes().length!==1?r.warn(`[${G}]: quantizationVolume=scene requires exactly 1 scene.`):i=vr(this.document.getRoot().listScenes().pop()));for(const a of Array.from(s.keys())){const u=s.get(a);if(!u)throw new Error("Unexpected primitive.");if(n.has(u)){n.set(u,n.get(u));continue}const g=a.getIndices(),p=e.jsonDoc.json.accessors;let T;try{T=Nn(a,de({},this._encoderOptions,{quantizationVolume:i}))}catch(E){if(E instanceof Pt){r.warn(`[${G}]: ${E.message} Skipping primitive compression.`);continue}throw E}n.set(u,T);const x=e.createAccessorDef(g);x.count=T.numIndices,e.accessorIndexMap.set(g,p.length),p.push(x);for(const E of a.listSemantics()){const A=a.getAttribute(E);if(T.attributeIDs[E]===void 0)continue;const l=e.createAccessorDef(A);l.count=T.numVertices,e.accessorIndexMap.set(A,p.length),p.push(l)}const R=a.getAttribute("POSITION").getBuffer()||this.document.getRoot().listBuffers()[0];e.otherBufferViews.has(R)||e.otherBufferViews.set(R,[]),e.otherBufferViews.get(R).push(T.data)}return r.debug(`[${G}] Compressed ${s.size} primitives.`),e.extensionData[G]={primitiveHashMap:s,primitiveEncodingMap:n},this}write(e){const t=e.extensionData[G];for(const r of this.document.getRoot().listMeshes()){const s=e.jsonDoc.json.meshes[e.meshIndexMap.get(r)];for(let n=0;n<r.listPrimitives().length;n++){const i=r.listPrimitives()[n],a=s.primitives[n],u=t.primitiveHashMap.get(i);if(!u)continue;const g=t.primitiveEncodingMap.get(u);g&&(a.extensions=a.extensions||{},a.extensions[G]={bufferView:e.otherBufferViewsIndexMap.get(g.data),attributes:g.attributeIDs})}}if(!t.primitiveHashMap.size){const r=e.jsonDoc.json;r.extensionsUsed=(r.extensionsUsed||[]).filter(s=>s!==G),r.extensionsRequired=(r.extensionsRequired||[]).filter(s=>s!==G)}return this}}function Is(o,e){const t=[],r=o.getIndices();t.push(e.get(r));for(const s of o.listAttributes())t.push(e.get(s));return t.sort().join("|")}Rs.EXTENSION_NAME=G,Rs.EncoderMethod=st;class Ve extends k{init(){this.extensionName=Xt,this.propertyType="Light",this.parentTypes=[m.NODE]}getDefaults(){return Object.assign(super.getDefaults(),{color:[1,1,1],intensity:1,type:Ve.Type.POINT,range:null,innerConeAngle:0,outerConeAngle:Math.PI/4})}getColor(){return this.get("color")}setColor(e){return this.set("color",e)}getColorHex(){return se.factorToHex(this.getColor())}setColorHex(e){const t=this.getColor().slice();return se.hexToFactor(e,t),this.setColor(t)}getIntensity(){return this.get("intensity")}setIntensity(e){return this.set("intensity",e)}getType(){return this.get("type")}setType(e){return this.set("type",e)}getRange(){return this.get("range")}setRange(e){return this.set("range",e)}getInnerConeAngle(){return this.get("innerConeAngle")}setInnerConeAngle(e){return this.set("innerConeAngle",e)}getOuterConeAngle(){return this.get("outerConeAngle")}setOuterConeAngle(e){return this.set("outerConeAngle",e)}}Ve.EXTENSION_NAME=Xt,Ve.Type={POINT:"point",SPOT:"spot",DIRECTIONAL:"directional"};const ue=Xt;class bn extends V{constructor(...e){super(...e),this.extensionName=ue}createLight(e=""){return new Ve(this.document.getGraph(),e)}read(e){const t=e.jsonDoc;if(!t.json.extensions||!t.json.extensions[ue])return this;const r=(t.json.extensions[ue].lights||[]).map(s=>{var n,i;const a=this.createLight().setName(s.name||"").setType(s.type);return s.color!==void 0&&a.setColor(s.color),s.intensity!==void 0&&a.setIntensity(s.intensity),s.range!==void 0&&a.setRange(s.range),((n=s.spot)==null?void 0:n.innerConeAngle)!==void 0&&a.setInnerConeAngle(s.spot.innerConeAngle),((i=s.spot)==null?void 0:i.outerConeAngle)!==void 0&&a.setOuterConeAngle(s.spot.outerConeAngle),a});return t.json.nodes.forEach((s,n)=>{s.extensions&&s.extensions[ue]&&e.nodes[n].setExtension(ue,r[s.extensions[ue].light])}),this}write(e){const t=e.jsonDoc;if(this.properties.size===0)return this;const r=[],s=new Map;for(const n of this.properties){const i=n,a={type:i.getType()};j.eq(i.getColor(),[1,1,1])||(a.color=i.getColor()),i.getIntensity()!==1&&(a.intensity=i.getIntensity()),i.getRange()!=null&&(a.range=i.getRange()),i.getName()&&(a.name=i.getName()),i.getType()===Ve.Type.SPOT&&(a.spot={innerConeAngle:i.getInnerConeAngle(),outerConeAngle:i.getOuterConeAngle()}),r.push(a),s.set(i,r.length-1)}return this.document.getRoot().listNodes().forEach(n=>{const i=n.getExtension(ue);if(i){const a=e.nodeIndexMap.get(n),u=t.json.nodes[a];u.extensions=u.extensions||{},u.extensions[ue]={light:s.get(i)}}}),t.json.extensions=t.json.extensions||{},t.json.extensions[ue]={lights:r},this}}bn.EXTENSION_NAME=ue;const{R:wn,G:Cn,B:On}=ae;let sr=class extends k{init(){this.extensionName=qt,this.propertyType="Anisotropy",this.parentTypes=[m.MATERIAL]}getDefaults(){return Object.assign(super.getDefaults(),{anisotropyStrength:0,anisotropyRotation:0,anisotropyTexture:null,anisotropyTextureInfo:new B(this.graph,"anisotropyTextureInfo")})}getAnisotropyStrength(){return this.get("anisotropyStrength")}setAnisotropyStrength(e){return this.set("anisotropyStrength",e)}getAnisotropyRotation(){return this.get("anisotropyRotation")}setAnisotropyRotation(e){return this.set("anisotropyRotation",e)}getAnisotropyTexture(){return this.getRef("anisotropyTexture")}getAnisotropyTextureInfo(){return this.getRef("anisotropyTexture")?this.getRef("anisotropyTextureInfo"):null}setAnisotropyTexture(e){return this.setRef("anisotropyTexture",e,{channels:wn|Cn|On})}};sr.EXTENSION_NAME=qt;const Ee=qt;let _n=class extends V{constructor(...e){super(...e),this.extensionName=Ee}createAnisotropy(){return new sr(this.document.getGraph())}read(e){const t=e.jsonDoc,r=t.json.textures||[];return(t.json.materials||[]).forEach((s,n)=>{if(s.extensions&&s.extensions[Ee]){const i=this.createAnisotropy();e.materials[n].setExtension(Ee,i);const a=s.extensions[Ee];if(a.anisotropyStrength!==void 0&&i.setAnisotropyStrength(a.anisotropyStrength),a.anisotropyRotation!==void 0&&i.setAnisotropyRotation(a.anisotropyRotation),a.anisotropyTexture!==void 0){const u=a.anisotropyTexture;i.setAnisotropyTexture(e.textures[r[u.index].source]),e.setTextureInfo(i.getAnisotropyTextureInfo(),u)}}}),this}write(e){const t=e.jsonDoc;return this.document.getRoot().listMaterials().forEach(r=>{const s=r.getExtension(Ee);if(s){const n=e.materialIndexMap.get(r),i=t.json.materials[n];i.extensions=i.extensions||{};const a=i.extensions[Ee]={};if(s.getAnisotropyStrength()>0&&(a.anisotropyStrength=s.getAnisotropyStrength()),s.getAnisotropyRotation()!==0&&(a.anisotropyRotation=s.getAnisotropyRotation()),s.getAnisotropyTexture()){const u=s.getAnisotropyTexture(),g=s.getAnisotropyTextureInfo();a.anisotropyTexture=e.createTextureInfoDef(u,g)}}}),this}};_n.EXTENSION_NAME=Ee;const{R:As,G:Ns,B:vn}=ae;class rr extends k{init(){this.extensionName=Yt,this.propertyType="Clearcoat",this.parentTypes=[m.MATERIAL]}getDefaults(){return Object.assign(super.getDefaults(),{clearcoatFactor:0,clearcoatTexture:null,clearcoatTextureInfo:new B(this.graph,"clearcoatTextureInfo"),clearcoatRoughnessFactor:0,clearcoatRoughnessTexture:null,clearcoatRoughnessTextureInfo:new B(this.graph,"clearcoatRoughnessTextureInfo"),clearcoatNormalScale:1,clearcoatNormalTexture:null,clearcoatNormalTextureInfo:new B(this.graph,"clearcoatNormalTextureInfo")})}getClearcoatFactor(){return this.get("clearcoatFactor")}setClearcoatFactor(e){return this.set("clearcoatFactor",e)}getClearcoatTexture(){return this.getRef("clearcoatTexture")}getClearcoatTextureInfo(){return this.getRef("clearcoatTexture")?this.getRef("clearcoatTextureInfo"):null}setClearcoatTexture(e){return this.setRef("clearcoatTexture",e,{channels:As})}getClearcoatRoughnessFactor(){return this.get("clearcoatRoughnessFactor")}setClearcoatRoughnessFactor(e){return this.set("clearcoatRoughnessFactor",e)}getClearcoatRoughnessTexture(){return this.getRef("clearcoatRoughnessTexture")}getClearcoatRoughnessTextureInfo(){return this.getRef("clearcoatRoughnessTexture")?this.getRef("clearcoatRoughnessTextureInfo"):null}setClearcoatRoughnessTexture(e){return this.setRef("clearcoatRoughnessTexture",e,{channels:Ns})}getClearcoatNormalScale(){return this.get("clearcoatNormalScale")}setClearcoatNormalScale(e){return this.set("clearcoatNormalScale",e)}getClearcoatNormalTexture(){return this.getRef("clearcoatNormalTexture")}getClearcoatNormalTextureInfo(){return this.getRef("clearcoatNormalTexture")?this.getRef("clearcoatNormalTextureInfo"):null}setClearcoatNormalTexture(e){return this.setRef("clearcoatNormalTexture",e,{channels:As|Ns|vn})}}rr.EXTENSION_NAME=Yt;const ye=Yt;class Dn extends V{constructor(...e){super(...e),this.extensionName=ye}createClearcoat(){return new rr(this.document.getGraph())}read(e){const t=e.jsonDoc,r=t.json.textures||[];return(t.json.materials||[]).forEach((s,n)=>{if(s.extensions&&s.extensions[ye]){const i=this.createClearcoat();e.materials[n].setExtension(ye,i);const a=s.extensions[ye];if(a.clearcoatFactor!==void 0&&i.setClearcoatFactor(a.clearcoatFactor),a.clearcoatRoughnessFactor!==void 0&&i.setClearcoatRoughnessFactor(a.clearcoatRoughnessFactor),a.clearcoatTexture!==void 0){const u=a.clearcoatTexture;i.setClearcoatTexture(e.textures[r[u.index].source]),e.setTextureInfo(i.getClearcoatTextureInfo(),u)}if(a.clearcoatRoughnessTexture!==void 0){const u=a.clearcoatRoughnessTexture;i.setClearcoatRoughnessTexture(e.textures[r[u.index].source]),e.setTextureInfo(i.getClearcoatRoughnessTextureInfo(),u)}if(a.clearcoatNormalTexture!==void 0){const u=a.clearcoatNormalTexture;i.setClearcoatNormalTexture(e.textures[r[u.index].source]),e.setTextureInfo(i.getClearcoatNormalTextureInfo(),u),u.scale!==void 0&&i.setClearcoatNormalScale(u.scale)}}}),this}write(e){const t=e.jsonDoc;return this.document.getRoot().listMaterials().forEach(r=>{const s=r.getExtension(ye);if(s){const n=e.materialIndexMap.get(r),i=t.json.materials[n];i.extensions=i.extensions||{};const a=i.extensions[ye]={clearcoatFactor:s.getClearcoatFactor(),clearcoatRoughnessFactor:s.getClearcoatRoughnessFactor()};if(s.getClearcoatTexture()){const u=s.getClearcoatTexture(),g=s.getClearcoatTextureInfo();a.clearcoatTexture=e.createTextureInfoDef(u,g)}if(s.getClearcoatRoughnessTexture()){const u=s.getClearcoatRoughnessTexture(),g=s.getClearcoatRoughnessTextureInfo();a.clearcoatRoughnessTexture=e.createTextureInfoDef(u,g)}if(s.getClearcoatNormalTexture()){const u=s.getClearcoatNormalTexture(),g=s.getClearcoatNormalTextureInfo();a.clearcoatNormalTexture=e.createTextureInfoDef(u,g),s.getClearcoatNormalScale()!==1&&(a.clearcoatNormalTexture.scale=s.getClearcoatNormalScale())}}}),this}}Dn.EXTENSION_NAME=ye;let nr=class extends k{init(){this.extensionName=Kt,this.propertyType="EmissiveStrength",this.parentTypes=[m.MATERIAL]}getDefaults(){return Object.assign(super.getDefaults(),{emissiveStrength:1})}getEmissiveStrength(){return this.get("emissiveStrength")}setEmissiveStrength(e){return this.set("emissiveStrength",e)}};nr.EXTENSION_NAME=Kt;const Re=Kt;let Fn=class extends V{constructor(...e){super(...e),this.extensionName=Re}createEmissiveStrength(){return new nr(this.document.getGraph())}read(e){return(e.jsonDoc.json.materials||[]).forEach((t,r)=>{if(t.extensions&&t.extensions[Re]){const s=this.createEmissiveStrength();e.materials[r].setExtension(Re,s);const n=t.extensions[Re];n.emissiveStrength!==void 0&&s.setEmissiveStrength(n.emissiveStrength)}}),this}write(e){const t=e.jsonDoc;return this.document.getRoot().listMaterials().forEach(r=>{const s=r.getExtension(Re);if(s){const n=e.materialIndexMap.get(r),i=t.json.materials[n];i.extensions=i.extensions||{},i.extensions[Re]={emissiveStrength:s.getEmissiveStrength()}}}),this}};Fn.EXTENSION_NAME=Re;class ir extends k{init(){this.extensionName=Wt,this.propertyType="IOR",this.parentTypes=[m.MATERIAL]}getDefaults(){return Object.assign(super.getDefaults(),{ior:1.5})}getIOR(){return this.get("ior")}setIOR(e){return this.set("ior",e)}}ir.EXTENSION_NAME=Wt;const Ie=Wt;class Un extends V{constructor(...e){super(...e),this.extensionName=Ie}createIOR(){return new ir(this.document.getGraph())}read(e){return(e.jsonDoc.json.materials||[]).forEach((t,r)=>{if(t.extensions&&t.extensions[Ie]){const s=this.createIOR();e.materials[r].setExtension(Ie,s);const n=t.extensions[Ie];n.ior!==void 0&&s.setIOR(n.ior)}}),this}write(e){const t=e.jsonDoc;return this.document.getRoot().listMaterials().forEach(r=>{const s=r.getExtension(Ie);if(s){const n=e.materialIndexMap.get(r),i=t.json.materials[n];i.extensions=i.extensions||{},i.extensions[Ie]={ior:s.getIOR()}}}),this}}Un.EXTENSION_NAME=Ie;const{R:Ln,G:Bn}=ae;class or extends k{init(){this.extensionName=Jt,this.propertyType="Iridescence",this.parentTypes=[m.MATERIAL]}getDefaults(){return Object.assign(super.getDefaults(),{iridescenceFactor:0,iridescenceTexture:null,iridescenceTextureInfo:new B(this.graph,"iridescenceTextureInfo"),iridescenceIOR:1.3,iridescenceThicknessMinimum:100,iridescenceThicknessMaximum:400,iridescenceThicknessTexture:null,iridescenceThicknessTextureInfo:new B(this.graph,"iridescenceThicknessTextureInfo")})}getIridescenceFactor(){return this.get("iridescenceFactor")}setIridescenceFactor(e){return this.set("iridescenceFactor",e)}getIridescenceTexture(){return this.getRef("iridescenceTexture")}getIridescenceTextureInfo(){return this.getRef("iridescenceTexture")?this.getRef("iridescenceTextureInfo"):null}setIridescenceTexture(e){return this.setRef("iridescenceTexture",e,{channels:Ln})}getIridescenceIOR(){return this.get("iridescenceIOR")}setIridescenceIOR(e){return this.set("iridescenceIOR",e)}getIridescenceThicknessMinimum(){return this.get("iridescenceThicknessMinimum")}setIridescenceThicknessMinimum(e){return this.set("iridescenceThicknessMinimum",e)}getIridescenceThicknessMaximum(){return this.get("iridescenceThicknessMaximum")}setIridescenceThicknessMaximum(e){return this.set("iridescenceThicknessMaximum",e)}getIridescenceThicknessTexture(){return this.getRef("iridescenceThicknessTexture")}getIridescenceThicknessTextureInfo(){return this.getRef("iridescenceThicknessTexture")?this.getRef("iridescenceThicknessTextureInfo"):null}setIridescenceThicknessTexture(e){return this.setRef("iridescenceThicknessTexture",e,{channels:Bn})}}or.EXTENSION_NAME=Jt;const Ae=Jt;class Pn extends V{constructor(...e){super(...e),this.extensionName=Ae}createIridescence(){return new or(this.document.getGraph())}read(e){const t=e.jsonDoc,r=t.json.textures||[];return(t.json.materials||[]).forEach((s,n)=>{if(s.extensions&&s.extensions[Ae]){const i=this.createIridescence();e.materials[n].setExtension(Ae,i);const a=s.extensions[Ae];if(a.iridescenceFactor!==void 0&&i.setIridescenceFactor(a.iridescenceFactor),a.iridescenceIor!==void 0&&i.setIridescenceIOR(a.iridescenceIor),a.iridescenceThicknessMinimum!==void 0&&i.setIridescenceThicknessMinimum(a.iridescenceThicknessMinimum),a.iridescenceThicknessMaximum!==void 0&&i.setIridescenceThicknessMaximum(a.iridescenceThicknessMaximum),a.iridescenceTexture!==void 0){const u=a.iridescenceTexture;i.setIridescenceTexture(e.textures[r[u.index].source]),e.setTextureInfo(i.getIridescenceTextureInfo(),u)}if(a.iridescenceThicknessTexture!==void 0){const u=a.iridescenceThicknessTexture;i.setIridescenceThicknessTexture(e.textures[r[u.index].source]),e.setTextureInfo(i.getIridescenceThicknessTextureInfo(),u)}}}),this}write(e){const t=e.jsonDoc;return this.document.getRoot().listMaterials().forEach(r=>{const s=r.getExtension(Ae);if(s){const n=e.materialIndexMap.get(r),i=t.json.materials[n];i.extensions=i.extensions||{};const a=i.extensions[Ae]={};if(s.getIridescenceFactor()>0&&(a.iridescenceFactor=s.getIridescenceFactor()),s.getIridescenceIOR()!==1.3&&(a.iridescenceIor=s.getIridescenceIOR()),s.getIridescenceThicknessMinimum()!==100&&(a.iridescenceThicknessMinimum=s.getIridescenceThicknessMinimum()),s.getIridescenceThicknessMaximum()!==400&&(a.iridescenceThicknessMaximum=s.getIridescenceThicknessMaximum()),s.getIridescenceTexture()){const u=s.getIridescenceTexture(),g=s.getIridescenceTextureInfo();a.iridescenceTexture=e.createTextureInfoDef(u,g)}if(s.getIridescenceThicknessTexture()){const u=s.getIridescenceThicknessTexture(),g=s.getIridescenceThicknessTextureInfo();a.iridescenceThicknessTexture=e.createTextureInfoDef(u,g)}}}),this}}Pn.EXTENSION_NAME=Ae;const{R:Ss,G:Ms,B:bs,A:ws}=ae;class ar extends k{init(){this.extensionName=Zt,this.propertyType="PBRSpecularGlossiness",this.parentTypes=[m.MATERIAL]}getDefaults(){return Object.assign(super.getDefaults(),{diffuseFactor:[1,1,1,1],diffuseTexture:null,diffuseTextureInfo:new B(this.graph,"diffuseTextureInfo"),specularFactor:[1,1,1],glossinessFactor:1,specularGlossinessTexture:null,specularGlossinessTextureInfo:new B(this.graph,"specularGlossinessTextureInfo")})}getDiffuseFactor(){return this.get("diffuseFactor")}setDiffuseFactor(e){return this.set("diffuseFactor",e)}getDiffuseHex(){return se.factorToHex(this.getDiffuseFactor())}setDiffuseHex(e){const t=this.getDiffuseFactor().slice();return this.setDiffuseFactor(se.hexToFactor(e,t))}getDiffuseTexture(){return this.getRef("diffuseTexture")}getDiffuseTextureInfo(){return this.getRef("diffuseTexture")?this.getRef("diffuseTextureInfo"):null}setDiffuseTexture(e){return this.setRef("diffuseTexture",e,{channels:Ss|Ms|bs|ws,isColor:!0})}getSpecularFactor(){return this.get("specularFactor")}setSpecularFactor(e){return this.set("specularFactor",e)}getGlossinessFactor(){return this.get("glossinessFactor")}setGlossinessFactor(e){return this.set("glossinessFactor",e)}getSpecularGlossinessTexture(){return this.getRef("specularGlossinessTexture")}getSpecularGlossinessTextureInfo(){return this.getRef("specularGlossinessTexture")?this.getRef("specularGlossinessTextureInfo"):null}setSpecularGlossinessTexture(e){return this.setRef("specularGlossinessTexture",e,{channels:Ss|Ms|bs|ws})}}ar.EXTENSION_NAME=Zt;const Ne=Zt;class jn extends V{constructor(...e){super(...e),this.extensionName=Ne}createPBRSpecularGlossiness(){return new ar(this.document.getGraph())}read(e){const t=e.jsonDoc,r=t.json.textures||[];return(t.json.materials||[]).forEach((s,n)=>{if(s.extensions&&s.extensions[Ne]){const i=this.createPBRSpecularGlossiness();e.materials[n].setExtension(Ne,i);const a=s.extensions[Ne];if(a.diffuseFactor!==void 0&&i.setDiffuseFactor(a.diffuseFactor),a.specularFactor!==void 0&&i.setSpecularFactor(a.specularFactor),a.glossinessFactor!==void 0&&i.setGlossinessFactor(a.glossinessFactor),a.diffuseTexture!==void 0){const u=a.diffuseTexture;i.setDiffuseTexture(e.textures[r[u.index].source]),e.setTextureInfo(i.getDiffuseTextureInfo(),u)}if(a.specularGlossinessTexture!==void 0){const u=a.specularGlossinessTexture;i.setSpecularGlossinessTexture(e.textures[r[u.index].source]),e.setTextureInfo(i.getSpecularGlossinessTextureInfo(),u)}}}),this}write(e){const t=e.jsonDoc;return this.document.getRoot().listMaterials().forEach(r=>{const s=r.getExtension(Ne);if(s){const n=e.materialIndexMap.get(r),i=t.json.materials[n];i.extensions=i.extensions||{};const a=i.extensions[Ne]={diffuseFactor:s.getDiffuseFactor(),specularFactor:s.getSpecularFactor(),glossinessFactor:s.getGlossinessFactor()};if(s.getDiffuseTexture()){const u=s.getDiffuseTexture(),g=s.getDiffuseTextureInfo();a.diffuseTexture=e.createTextureInfoDef(u,g)}if(s.getSpecularGlossinessTexture()){const u=s.getSpecularGlossinessTexture(),g=s.getSpecularGlossinessTextureInfo();a.specularGlossinessTexture=e.createTextureInfoDef(u,g)}}}),this}}jn.EXTENSION_NAME=Ne;const{R:Vn,G:kn,B:Gn,A:$n}=ae;class cr extends k{init(){this.extensionName=Qt,this.propertyType="Sheen",this.parentTypes=[m.MATERIAL]}getDefaults(){return Object.assign(super.getDefaults(),{sheenColorFactor:[0,0,0],sheenColorTexture:null,sheenColorTextureInfo:new B(this.graph,"sheenColorTextureInfo"),sheenRoughnessFactor:0,sheenRoughnessTexture:null,sheenRoughnessTextureInfo:new B(this.graph,"sheenRoughnessTextureInfo")})}getSheenColorFactor(){return this.get("sheenColorFactor")}getSheenColorHex(){return se.factorToHex(this.getSheenColorFactor())}setSheenColorFactor(e){return this.set("sheenColorFactor",e)}setSheenColorHex(e){const t=this.getSheenColorFactor().slice();return this.set("sheenColorFactor",se.hexToFactor(e,t))}getSheenColorTexture(){return this.getRef("sheenColorTexture")}getSheenColorTextureInfo(){return this.getRef("sheenColorTexture")?this.getRef("sheenColorTextureInfo"):null}setSheenColorTexture(e){return this.setRef("sheenColorTexture",e,{channels:Vn|kn|Gn,isColor:!0})}getSheenRoughnessFactor(){return this.get("sheenRoughnessFactor")}setSheenRoughnessFactor(e){return this.set("sheenRoughnessFactor",e)}getSheenRoughnessTexture(){return this.getRef("sheenRoughnessTexture")}getSheenRoughnessTextureInfo(){return this.getRef("sheenRoughnessTexture")?this.getRef("sheenRoughnessTextureInfo"):null}setSheenRoughnessTexture(e){return this.setRef("sheenRoughnessTexture",e,{channels:$n})}}cr.EXTENSION_NAME=Qt;const Se=Qt;class zn extends V{constructor(...e){super(...e),this.extensionName=Se}createSheen(){return new cr(this.document.getGraph())}read(e){const t=e.jsonDoc,r=t.json.textures||[];return(t.json.materials||[]).forEach((s,n)=>{if(s.extensions&&s.extensions[Se]){const i=this.createSheen();e.materials[n].setExtension(Se,i);const a=s.extensions[Se];if(a.sheenColorFactor!==void 0&&i.setSheenColorFactor(a.sheenColorFactor),a.sheenRoughnessFactor!==void 0&&i.setSheenRoughnessFactor(a.sheenRoughnessFactor),a.sheenColorTexture!==void 0){const u=a.sheenColorTexture;i.setSheenColorTexture(e.textures[r[u.index].source]),e.setTextureInfo(i.getSheenColorTextureInfo(),u)}if(a.sheenRoughnessTexture!==void 0){const u=a.sheenRoughnessTexture;i.setSheenRoughnessTexture(e.textures[r[u.index].source]),e.setTextureInfo(i.getSheenRoughnessTextureInfo(),u)}}}),this}write(e){const t=e.jsonDoc;return this.document.getRoot().listMaterials().forEach(r=>{const s=r.getExtension(Se);if(s){const n=e.materialIndexMap.get(r),i=t.json.materials[n];i.extensions=i.extensions||{};const a=i.extensions[Se]={sheenColorFactor:s.getSheenColorFactor(),sheenRoughnessFactor:s.getSheenRoughnessFactor()};if(s.getSheenColorTexture()){const u=s.getSheenColorTexture(),g=s.getSheenColorTextureInfo();a.sheenColorTexture=e.createTextureInfoDef(u,g)}if(s.getSheenRoughnessTexture()){const u=s.getSheenRoughnessTexture(),g=s.getSheenRoughnessTextureInfo();a.sheenRoughnessTexture=e.createTextureInfoDef(u,g)}}}),this}}zn.EXTENSION_NAME=Se;const{R:Hn,G:Xn,B:qn,A:Yn}=ae;class ur extends k{init(){this.extensionName=es,this.propertyType="Specular",this.parentTypes=[m.MATERIAL]}getDefaults(){return Object.assign(super.getDefaults(),{specularFactor:1,specularTexture:null,specularTextureInfo:new B(this.graph,"specularTextureInfo"),specularColorFactor:[1,1,1],specularColorTexture:null,specularColorTextureInfo:new B(this.graph,"specularColorTextureInfo")})}getSpecularFactor(){return this.get("specularFactor")}setSpecularFactor(e){return this.set("specularFactor",e)}getSpecularColorFactor(){return this.get("specularColorFactor")}setSpecularColorFactor(e){return this.set("specularColorFactor",e)}getSpecularColorHex(){return se.factorToHex(this.getSpecularColorFactor())}setSpecularColorHex(e){const t=this.getSpecularColorFactor().slice();return this.set("specularColorFactor",se.hexToFactor(e,t))}getSpecularTexture(){return this.getRef("specularTexture")}getSpecularTextureInfo(){return this.getRef("specularTexture")?this.getRef("specularTextureInfo"):null}setSpecularTexture(e){return this.setRef("specularTexture",e,{channels:Yn})}getSpecularColorTexture(){return this.getRef("specularColorTexture")}getSpecularColorTextureInfo(){return this.getRef("specularColorTexture")?this.getRef("specularColorTextureInfo"):null}setSpecularColorTexture(e){return this.setRef("specularColorTexture",e,{channels:Hn|Xn|qn,isColor:!0})}}ur.EXTENSION_NAME=es;const Me=es;class Kn extends V{constructor(...e){super(...e),this.extensionName=Me}createSpecular(){return new ur(this.document.getGraph())}read(e){const t=e.jsonDoc,r=t.json.textures||[];return(t.json.materials||[]).forEach((s,n)=>{if(s.extensions&&s.extensions[Me]){const i=this.createSpecular();e.materials[n].setExtension(Me,i);const a=s.extensions[Me];if(a.specularFactor!==void 0&&i.setSpecularFactor(a.specularFactor),a.specularColorFactor!==void 0&&i.setSpecularColorFactor(a.specularColorFactor),a.specularTexture!==void 0){const u=a.specularTexture;i.setSpecularTexture(e.textures[r[u.index].source]),e.setTextureInfo(i.getSpecularTextureInfo(),u)}if(a.specularColorTexture!==void 0){const u=a.specularColorTexture;i.setSpecularColorTexture(e.textures[r[u.index].source]),e.setTextureInfo(i.getSpecularColorTextureInfo(),u)}}}),this}write(e){const t=e.jsonDoc;return this.document.getRoot().listMaterials().forEach(r=>{const s=r.getExtension(Me);if(s){const n=e.materialIndexMap.get(r),i=t.json.materials[n];i.extensions=i.extensions||{};const a=i.extensions[Me]={};if(s.getSpecularFactor()!==1&&(a.specularFactor=s.getSpecularFactor()),j.eq(s.getSpecularColorFactor(),[1,1,1])||(a.specularColorFactor=s.getSpecularColorFactor()),s.getSpecularTexture()){const u=s.getSpecularTexture(),g=s.getSpecularTextureInfo();a.specularTexture=e.createTextureInfoDef(u,g)}if(s.getSpecularColorTexture()){const u=s.getSpecularColorTexture(),g=s.getSpecularColorTextureInfo();a.specularColorTexture=e.createTextureInfoDef(u,g)}}}),this}}Kn.EXTENSION_NAME=Me;const{R:Wn}=ae;class lr extends k{init(){this.extensionName=ts,this.propertyType="Transmission",this.parentTypes=[m.MATERIAL]}getDefaults(){return Object.assign(super.getDefaults(),{transmissionFactor:0,transmissionTexture:null,transmissionTextureInfo:new B(this.graph,"transmissionTextureInfo")})}getTransmissionFactor(){return this.get("transmissionFactor")}setTransmissionFactor(e){return this.set("transmissionFactor",e)}getTransmissionTexture(){return this.getRef("transmissionTexture")}getTransmissionTextureInfo(){return this.getRef("transmissionTexture")?this.getRef("transmissionTextureInfo"):null}setTransmissionTexture(e){return this.setRef("transmissionTexture",e,{channels:Wn})}}lr.EXTENSION_NAME=ts;const be=ts;class Jn extends V{constructor(...e){super(...e),this.extensionName=be}createTransmission(){return new lr(this.document.getGraph())}read(e){const t=e.jsonDoc,r=t.json.textures||[];return(t.json.materials||[]).forEach((s,n)=>{if(s.extensions&&s.extensions[be]){const i=this.createTransmission();e.materials[n].setExtension(be,i);const a=s.extensions[be];if(a.transmissionFactor!==void 0&&i.setTransmissionFactor(a.transmissionFactor),a.transmissionTexture!==void 0){const u=a.transmissionTexture;i.setTransmissionTexture(e.textures[r[u.index].source]),e.setTextureInfo(i.getTransmissionTextureInfo(),u)}}}),this}write(e){const t=e.jsonDoc;return this.document.getRoot().listMaterials().forEach(r=>{const s=r.getExtension(be);if(s){const n=e.materialIndexMap.get(r),i=t.json.materials[n];i.extensions=i.extensions||{};const a=i.extensions[be]={transmissionFactor:s.getTransmissionFactor()};if(s.getTransmissionTexture()){const u=s.getTransmissionTexture(),g=s.getTransmissionTextureInfo();a.transmissionTexture=e.createTextureInfoDef(u,g)}}}),this}}Jn.EXTENSION_NAME=be;class hr extends k{init(){this.extensionName=ss,this.propertyType="Unlit",this.parentTypes=[m.MATERIAL]}}hr.EXTENSION_NAME=ss;const Fe=ss;class Zn extends V{constructor(...e){super(...e),this.extensionName=Fe}createUnlit(){return new hr(this.document.getGraph())}read(e){return(e.jsonDoc.json.materials||[]).forEach((t,r)=>{t.extensions&&t.extensions[Fe]&&e.materials[r].setExtension(Fe,this.createUnlit())}),this}write(e){const t=e.jsonDoc;return this.document.getRoot().listMaterials().forEach(r=>{if(r.getExtension(Fe)){const s=e.materialIndexMap.get(r),n=t.json.materials[s];n.extensions=n.extensions||{},n.extensions[Fe]={}}}),this}}Zn.EXTENSION_NAME=Fe;class fr extends k{init(){this.extensionName=ve,this.propertyType="Mapping",this.parentTypes=["MappingList"]}getDefaults(){return Object.assign(super.getDefaults(),{material:null,variants:[]})}getMaterial(){return this.getRef("material")}setMaterial(e){return this.setRef("material",e)}addVariant(e){return this.addRef("variants",e)}removeVariant(e){return this.removeRef("variants",e)}listVariants(){return this.listRefs("variants")}}fr.EXTENSION_NAME=ve;class gr extends k{init(){this.extensionName=ve,this.propertyType="MappingList",this.parentTypes=[m.PRIMITIVE]}getDefaults(){return Object.assign(super.getDefaults(),{mappings:[]})}addMapping(e){return this.addRef("mappings",e)}removeMapping(e){return this.removeRef("mappings",e)}listMappings(){return this.listRefs("mappings")}}gr.EXTENSION_NAME=ve;class jt extends k{init(){this.extensionName=ve,this.propertyType="Variant",this.parentTypes=["MappingList"]}}jt.EXTENSION_NAME=ve;const le=ve;class Qn extends V{constructor(...e){super(...e),this.extensionName=le}createMappingList(){return new gr(this.document.getGraph())}createVariant(e=""){return new jt(this.document.getGraph(),e)}createMapping(){return new fr(this.document.getGraph())}listVariants(){return Array.from(this.properties).filter(e=>e instanceof jt)}read(e){const t=e.jsonDoc;if(!t.json.extensions||!t.json.extensions[le])return this;const r=(t.json.extensions[le].variants||[]).map(s=>this.createVariant().setName(s.name||""));return(t.json.meshes||[]).forEach((s,n)=>{const i=e.meshes[n];(s.primitives||[]).forEach((a,u)=>{if(!a.extensions||!a.extensions[le])return;const g=this.createMappingList(),p=a.extensions[le];for(const T of p.mappings){const x=this.createMapping();T.material!==void 0&&x.setMaterial(e.materials[T.material]);for(const R of T.variants||[])x.addVariant(r[R]);g.addMapping(x)}i.listPrimitives()[u].setExtension(le,g)})}),this}write(e){const t=e.jsonDoc,r=this.listVariants();if(!r.length)return this;const s=[],n=new Map;for(const i of r)n.set(i,s.length),s.push(e.createPropertyDef(i));for(const i of this.document.getRoot().listMeshes()){const a=e.meshIndexMap.get(i);i.listPrimitives().forEach((u,g)=>{const p=u.getExtension(le);if(!p)return;const T=e.jsonDoc.json.meshes[a].primitives[g],x=p.listMappings().map(R=>{const E=e.createPropertyDef(R),A=R.getMaterial();return A&&(E.material=e.materialIndexMap.get(A)),E.variants=R.listVariants().map(l=>n.get(l)),E});T.extensions=T.extensions||{},T.extensions[le]={mappings:x}})}return t.json.extensions=t.json.extensions||{},t.json.extensions[le]={variants:s},this}}Qn.EXTENSION_NAME=le;const{G:ei}=ae;class pr extends k{init(){this.extensionName=rs,this.propertyType="Volume",this.parentTypes=[m.MATERIAL]}getDefaults(){return Object.assign(super.getDefaults(),{thicknessFactor:0,thicknessTexture:null,thicknessTextureInfo:new B(this.graph,"thicknessTexture"),attenuationDistance:1/0,attenuationColor:[1,1,1]})}getThicknessFactor(){return this.get("thicknessFactor")}setThicknessFactor(e){return this.set("thicknessFactor",e)}getThicknessTexture(){return this.getRef("thicknessTexture")}getThicknessTextureInfo(){return this.getRef("thicknessTexture")?this.getRef("thicknessTextureInfo"):null}setThicknessTexture(e){return this.setRef("thicknessTexture",e,{channels:ei})}getAttenuationDistance(){return this.get("attenuationDistance")}setAttenuationDistance(e){return this.set("attenuationDistance",e)}getAttenuationColor(){return this.get("attenuationColor")}setAttenuationColor(e){return this.set("attenuationColor",e)}getAttenuationColorHex(){return se.factorToHex(this.getAttenuationColor())}setAttenuationColorHex(e){const t=this.getAttenuationColor().slice();return this.set("attenuationColor",se.hexToFactor(e,t))}}pr.EXTENSION_NAME=rs;const we=rs;class ti extends V{constructor(...e){super(...e),this.extensionName=we}createVolume(){return new pr(this.document.getGraph())}read(e){const t=e.jsonDoc,r=t.json.textures||[];return(t.json.materials||[]).forEach((s,n)=>{if(s.extensions&&s.extensions[we]){const i=this.createVolume();e.materials[n].setExtension(we,i);const a=s.extensions[we];if(a.thicknessFactor!==void 0&&i.setThicknessFactor(a.thicknessFactor),a.attenuationDistance!==void 0&&i.setAttenuationDistance(a.attenuationDistance),a.attenuationColor!==void 0&&i.setAttenuationColor(a.attenuationColor),a.thicknessTexture!==void 0){const u=a.thicknessTexture;i.setThicknessTexture(e.textures[r[u.index].source]),e.setTextureInfo(i.getThicknessTextureInfo(),u)}}}),this}write(e){const t=e.jsonDoc;return this.document.getRoot().listMaterials().forEach(r=>{const s=r.getExtension(we);if(s){const n=e.materialIndexMap.get(r),i=t.json.materials[n];i.extensions=i.extensions||{};const a=i.extensions[we]={};if(s.getThicknessFactor()>0&&(a.thicknessFactor=s.getThicknessFactor()),Number.isFinite(s.getAttenuationDistance())&&(a.attenuationDistance=s.getAttenuationDistance()),j.eq(s.getAttenuationColor(),[1,1,1])||(a.attenuationColor=s.getAttenuationColor()),s.getThicknessTexture()){const u=s.getThicknessTexture(),g=s.getThicknessTextureInfo();a.thicknessTexture=e.createTextureInfoDef(u,g)}}}),this}}ti.EXTENSION_NAME=we;const dr="KHR_mesh_quantization";class si extends V{constructor(...e){super(...e),this.extensionName=dr}read(e){return this}write(e){return this}}si.EXTENSION_NAME=dr;const Ye="KHR_texture_basisu";class ri{match(e){return e[0]===171&&e[1]===75&&e[2]===84&&e[3]===88&&e[4]===32&&e[5]===50&&e[6]===48&&e[7]===187&&e[8]===13&&e[9]===10&&e[10]===26&&e[11]===10}getSize(e){const t=bt(e);return[t.pixelWidth,t.pixelHeight]}getChannels(e){const t=bt(e).dataFormatDescriptor[0];if(t.colorModel===sn)return t.samples.length===2&&(15&t.samples[1].channelType)==15?4:3;if(t.colorModel===rn)return(15&t.samples[0].channelType)==3?4:3;throw new Error(`Unexpected KTX2 colorModel, "${t.colorModel}".`)}getVRAMByteLength(e){const t=bt(e),r=this.getChannels(e)>3;let s=0;for(let n=0;n<t.levels.length;n++){const i=t.levels[n];s+=i.uncompressedByteLength?i.uncompressedByteLength:Math.max(1,Math.floor(t.pixelWidth/Math.pow(2,n)))/4*(Math.max(1,Math.floor(t.pixelHeight/Math.pow(2,n)))/4)*(r?16:8)}return s}}class ni extends V{constructor(...e){super(...e),this.extensionName=Ye,this.prereadTypes=[m.TEXTURE]}static register(){he.registerFormat("image/ktx2",new ri)}preread(e){return e.jsonDoc.json.textures.forEach(t=>{t.extensions&&t.extensions[Ye]&&(t.source=t.extensions[Ye].source)}),this}read(e){return this}write(e){const t=e.jsonDoc;return this.document.getRoot().listTextures().forEach(r=>{if(r.getMimeType()==="image/ktx2"){const s=e.imageIndexMap.get(r);t.json.textures.forEach(n=>{n.source===s&&(n.extensions=n.extensions||{},n.extensions[Ye]={source:n.source},delete n.source)})}}),this}}ni.EXTENSION_NAME=Ye;class mr extends k{init(){this.extensionName=ns,this.propertyType="Transform",this.parentTypes=[m.TEXTURE_INFO]}getDefaults(){return Object.assign(super.getDefaults(),{offset:[0,0],rotation:0,scale:[1,1],texCoord:null})}getOffset(){return this.get("offset")}setOffset(e){return this.set("offset",e)}getRotation(){return this.get("rotation")}setRotation(e){return this.set("rotation",e)}getScale(){return this.get("scale")}setScale(e){return this.set("scale",e)}getTexCoord(){return this.get("texCoord")}setTexCoord(e){return this.set("texCoord",e)}}mr.EXTENSION_NAME=ns;const Ce=ns;class ii extends V{constructor(...e){super(...e),this.extensionName=Ce}createTransform(){return new mr(this.document.getGraph())}read(e){for(const[t,r]of Array.from(e.textureInfos.entries())){if(!r.extensions||!r.extensions[Ce])continue;const s=this.createTransform(),n=r.extensions[Ce];n.offset!==void 0&&s.setOffset(n.offset),n.rotation!==void 0&&s.setRotation(n.rotation),n.scale!==void 0&&s.setScale(n.scale),n.texCoord!==void 0&&s.setTexCoord(n.texCoord),t.setExtension(Ce,s)}return this}write(e){const t=Array.from(e.textureInfoDefMap.entries());for(const[r,s]of t){const n=r.getExtension(Ce);if(!n)continue;s.extensions=s.extensions||{};const i={},a=j.eq;a(n.getOffset(),[0,0])||(i.offset=n.getOffset()),n.getRotation()!==0&&(i.rotation=n.getRotation()),a(n.getScale(),[1,1])||(i.scale=n.getScale()),n.getTexCoord()!=null&&(i.texCoord=n.getTexCoord()),s.extensions[Ce]=i}return this}}ii.EXTENSION_NAME=Ce;const oi=[m.ROOT,m.SCENE,m.NODE,m.MESH,m.MATERIAL,m.TEXTURE,m.ANIMATION];class xr extends k{init(){this.extensionName=yt,this.propertyType="Packet",this.parentTypes=oi}getDefaults(){return Object.assign(super.getDefaults(),{context:{},properties:{}})}getContext(){return this.get("context")}setContext(e){return this.set("context",de({},e))}listProperties(){return Object.keys(this.get("properties"))}getProperty(e){const t=this.get("properties");return e in t?t[e]:null}setProperty(e,t){this._assertContext(e);const r=de({},this.get("properties"));return t?r[e]=t:delete r[e],this.set("properties",r)}toJSONLD(){return de({"@context":Ct(this.get("context"))},Ct(this.get("properties")))}fromJSONLD(e){const t=(e=Ct(e))["@context"];return t&&this.set("context",t),delete e["@context"],this.set("properties",e)}_assertContext(e){if(!(e.split(":")[0]in this.get("context")))throw new Error(`${yt}: Missing context for term, "${e}".`)}}function Ct(o){return JSON.parse(JSON.stringify(o))}xr.EXTENSION_NAME=yt;const pe=yt;class ai extends V{constructor(...e){super(...e),this.extensionName=pe}createPacket(){return new xr(this.document.getGraph())}listPackets(){return Array.from(this.properties)}read(e){var t;const r=(t=e.jsonDoc.json.extensions)==null?void 0:t[pe];if(!r||!r.packets)return this;const s=e.jsonDoc.json,n=this.document.getRoot(),i=r.packets.map(g=>this.createPacket().fromJSONLD(g)),a=[[s.asset],s.scenes,s.nodes,s.meshes,s.materials,s.images,s.animations],u=[[n],n.listScenes(),n.listNodes(),n.listMeshes(),n.listMaterials(),n.listTextures(),n.listAnimations()];for(let g=0;g<a.length;g++){const p=a[g]||[];for(let T=0;T<p.length;T++){const x=p[T];x.extensions&&x.extensions[pe]&&u[g][T].setExtension(pe,i[x.extensions[pe].packet])}}return this}write(e){const{json:t}=e.jsonDoc,r=[];for(const s of this.properties){r.push(s.toJSONLD());for(const n of s.listParents()){let i;switch(n.propertyType){case m.ROOT:i=t.asset;break;case m.SCENE:i=t.scenes[e.sceneIndexMap.get(n)];break;case m.NODE:i=t.nodes[e.nodeIndexMap.get(n)];break;case m.MESH:i=t.meshes[e.meshIndexMap.get(n)];break;case m.MATERIAL:i=t.materials[e.materialIndexMap.get(n)];break;case m.TEXTURE:i=t.images[e.imageIndexMap.get(n)];break;case m.ANIMATION:i=t.animations[e.animationIndexMap.get(n)];break;default:i=null,this.document.getLogger().warn(`[${pe}]: Unsupported parent property, "${n.propertyType}"`)}i&&(i.extensions=i.extensions||{},i.extensions[pe]={packet:r.length-1})}}return r.length>0&&(t.extensions=t.extensions||{},t.extensions[pe]={packets:r}),this}}ai.EXTENSION_NAME=pe;function Rt(){return Rt=Object.assign?Object.assign.bind():function(o){for(var e=1;e<arguments.length;e++){var t=arguments[e];for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(o[r]=t[r])}return o},Rt.apply(this,arguments)}function Tr(o,e){return Object.defineProperty(e,"name",{value:o}),e}var It=typeof Float32Array<"u"?Float32Array:Array;function ci(){var o=new It(3);return It!=Float32Array&&(o[0]=0,o[1]=0,o[2]=0),o}function ui(){var o=new It(4);return It!=Float32Array&&(o[0]=0,o[1]=0,o[2]=0,o[3]=0),o}Math.hypot||(Math.hypot=function(){for(var o=0,e=arguments.length;e--;)o+=arguments[e]*arguments[e];return Math.sqrt(o)}),ci(),ui();m.ACCESSOR,m.MESH,m.TEXTURE,m.MATERIAL,m.SKIN;function li(o){const e=o.getGraph(),t=new Set,r=new Set;return function s(n){const i=new Set;for(const a of e.listChildEdges(n))a.getChild()instanceof et&&i.add(a.getName()+"Info");for(const a of e.listChildEdges(n)){const u=a.getChild();t.has(u)||(t.add(u),u instanceof B&&i.has(a.getName())?r.add(u):u instanceof k&&s(u))}}(o),Array.from(r)}const gt="prune",Cs={propertyTypes:[m.NODE,m.SKIN,m.MESH,m.CAMERA,m.PRIMITIVE,m.PRIMITIVE_TARGET,m.ANIMATION,m.MATERIAL,m.TEXTURE,m.ACCESSOR,m.BUFFER],keepLeaves:!1,keepAttributes:!0};function qi(o=Cs){const e=Rt({},Cs,o),t=new Set(e.propertyTypes);return Tr(gt,r=>{const s=r.getLogger(),n=r.getRoot(),i=r.getGraph(),a={};if(t.has(m.MESH))for(const x of n.listMeshes())x.listPrimitives().length>0||(x.dispose(),T(x));if(t.has(m.NODE)&&!e.keepLeaves&&n.listScenes().forEach(function x(R){if(R.listChildren().forEach(x),R instanceof $t)return;const E=i.listParentEdges(R).some(A=>{const l=A.getParent().propertyType;return l!==m.ROOT&&l!==m.SCENE&&l!==m.NODE});i.listChildren(R).length!==0||E||(R.dispose(),T(R))}),t.has(m.NODE)&&n.listNodes().forEach(u),t.has(m.SKIN)&&n.listSkins().forEach(u),t.has(m.MESH)&&n.listMeshes().forEach(u),t.has(m.CAMERA)&&n.listCameras().forEach(u),t.has(m.PRIMITIVE)&&g(i,m.PRIMITIVE),t.has(m.PRIMITIVE_TARGET)&&g(i,m.PRIMITIVE_TARGET),!e.keepAttributes&&t.has(m.ACCESSOR)){const x=new Map;for(const R of n.listMeshes())for(const E of R.listPrimitives()){const A=E.getMaterial(),l=hi(E,Er(r,A));p(E,l),E.listTargets().forEach(y=>p(y,l)),A&&(x.has(A)?x.get(A).add(E):x.set(A,new Set([E])))}for(const[R,E]of x)fi(R,Array.from(E))}if(t.has(m.ANIMATION))for(const x of n.listAnimations()){for(const R of x.listChannels())R.getTargetNode()||(R.dispose(),T(R));if(x.listChannels().length)x.listSamplers().forEach(u);else{const R=x.listSamplers();u(x),R.forEach(u)}}if(t.has(m.MATERIAL)&&n.listMaterials().forEach(u),t.has(m.TEXTURE)&&n.listTextures().forEach(u),t.has(m.ACCESSOR)&&n.listAccessors().forEach(u),t.has(m.BUFFER)&&n.listBuffers().forEach(u),Object.keys(a).length){const x=Object.keys(a).map(R=>`${R} (${a[R]})`).join(", ");s.info(`${gt}: Removed types... ${x}`)}else s.info(`${gt}: No unused properties found.`);function u(x){x.listParents().filter(R=>!(R instanceof zt||R instanceof rt)).length||(x.dispose(),T(x))}function g(x,R){x.listEdges().map(E=>E.getParent()).filter(E=>E.propertyType===R).forEach(u)}function p(x,R){for(const E of R)x.setAttribute(E,null)}function T(x){a[x.propertyType]=a[x.propertyType]||0,a[x.propertyType]++}s.debug(`${gt}: Complete.`)})}function hi(o,e){const t=[];for(const r of o.listSemantics())r!=="TANGENT"||e.has(r)?(r.startsWith("TEXCOORD_")&&!e.has(r)||r.startsWith("COLOR_")&&r!=="COLOR_0")&&t.push(r):t.push(r);return t}function Er(o,e,t=new Set){if(!e)return t;const r=o.getGraph().listChildEdges(e),s=new Set;for(const n of r)n.getChild()instanceof et&&s.add(n.getName());for(const n of r){const i=n.getName(),a=n.getChild();a instanceof B&&s.has(i.replace(/Info$/,""))&&t.add(`TEXCOORD_${a.getTexCoord()}`),a instanceof et&&i.match(/normalTexture/i)&&t.add("TANGENT"),a instanceof k&&Er(o,a,t)}return t}function fi(o,e){const t=li(o),r=new Set(t.map(u=>u.getTexCoord())),s=Array.from(r).sort(),n=new Map(s.map((u,g)=>[u,g])),i=new Map(s.map((u,g)=>[`TEXCOORD_${u}`,`TEXCOORD_${g}`]));for(const u of t){const g=u.getTexCoord();u.setTexCoord(n.get(g))}for(const u of e){const g=u.listSemantics().filter(p=>p.startsWith("TEXCOORD_")).sort();a(u,g),u.listTargets().forEach(p=>a(p,g))}function a(u,g){for(const p of g){const T=u.getAttribute(p);if(!T)continue;const x=i.get(p);x!==p&&(u.setAttribute(x,T),u.setAttribute(p,null))}}}rt.TargetPath;var Os;function Ge(o,e,t){for(let r=0,s=t.length;r<s;r++)t[r]=o[e*s+r];return t}function _s(o,e,t){for(let r=0,s=t.length;r<s;r++)o[e*s+r]=t[r]}function pt(o,e,t=0){if(o.length!==e.length)return!1;for(let r=0;r<o.length;r++)if(Math.abs(o[r]-e[r])>t)return!1;return!0}function gi(o,e,t){return o*(1-t)+e*t}function pi(o,e,t,r){for(let s=0;s<e.length;s++)o[s]=gi(e[s],t[s],r);return o}function di(o,e,t,r){let s,n,i,a,u,g=e[0],p=e[1],T=e[2],x=e[3],R=t[0],E=t[1],A=t[2],l=t[3];return n=g*R+p*E+T*A+x*l,n<0&&(n=-n,R=-R,E=-E,A=-A,l=-l),1-n>1e-6?(s=Math.acos(n),i=Math.sin(s),a=Math.sin((1-r)*s)/i,u=Math.sin(r*s)/i):(a=1-r,u=r),o[0]=a*g+u*R,o[1]=a*p+u*E,o[2]=a*T+u*A,o[3]=a*x+u*l,o}function vs(o,e){const t=function(r,s){return r[0]*s[0]+r[1]*s[1]+r[2]*s[2]+r[3]*s[3]}(o,e);return Math.acos(2*t*t-1)}(function(o){o[o.STEP=0]="STEP",o[o.LERP=1]="LERP",o[o.SLERP=2]="SLERP"})(Os||(Os={}));Promise.resolve();var At;(function(o){o.LANCZOS3="lanczos3",o.LANCZOS2="lanczos2"})(At||(At={}));At.LANCZOS3;At.LANCZOS3;const Ds="unpartition",Fs={};function Yi(o=Fs){return Rt({},Fs,o),Tr(Ds,async e=>{const t=e.getLogger(),r=e.getRoot().listBuffers()[0];e.getRoot().listAccessors().forEach(s=>s.setBuffer(r)),e.getRoot().listBuffers().forEach((s,n)=>n>0?s.dispose():null),t.debug(`${Ds}: Complete.`)})}export{ii as $,Jn as C,ki as D,Dn as H,ti as L,Rs as O,Un as Q,mi as _,_n as a,qi as b,Qe as l,Pn as t,Yi as v,zn as x};
